(function(O,E){typeof exports=="object"&&typeof module<"u"?E(exports):typeof define=="function"&&define.amd?define(["exports"],E):(O=typeof globalThis<"u"?globalThis:O||self,E(O.instant={}))})(this,function(O){"use strict";var ui=Object.defineProperty;var fi=(O,E,X)=>E in O?ui(O,E,{enumerable:!0,configurable:!0,writable:!0,value:X}):O[E]=X;var y=(O,E,X)=>fi(O,typeof E!="symbol"?E+"":E,X);let E=!1,X=!1,_t=!1;typeof window<"u"&&typeof window.localStorage<"u"&&(E=!!window.localStorage.getItem("devBackend"),X=!!window.localStorage.getItem("__instantLogging"),_t=!!window.localStorage.getItem("__devtoolLocalDash"));const Ee=E||X,A={info:Ee?console.info.bind(console):()=>{},debug:Ee?console.debug.bind(console):()=>{},error:Ee?console.error.bind(console):()=>{}};function x(t){if(typeof t=="number")return(Math.abs(t*2654435761)>>>0).toString(16);if(typeof t=="boolean")return t?"1":"0";if(t===null)return"null";if(t===void 0)return"undefined";if(typeof t=="string"){let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24),e=e>>>0;return e.toString(16)}if(Array.isArray(t)){let e=2166136261;for(let n=0;n<t.length;n++){e^=(n+1)*2654435761;const r=x(t[n]);for(let s=0;s<r.length;s++)e^=r.charCodeAt(s),e*=16777619,e=e>>>0}return e.toString(16)}if(typeof t=="object"){let e=2166136261;const n=Object.keys(t).sort();for(let r=0;r<n.length;r++){const s=n[r],i=x(s);e^=parseInt(i,16),e*=16777619,e=e>>>0;const o=x(t[s]);e^=parseInt(o,16),e*=16777619,e=e>>>0}return e.toString(16)}return x(String(t))}const P={Remove:"remove",Replace:"replace",Add:"add"},wt=Symbol.for("__MUTATIVE_PROXY_DRAFT__"),Mn=Symbol("__MUTATIVE_RAW_RETURN_SYMBOL__"),ye=Symbol.iterator,U={mutable:"mutable",immutable:"immutable"},Ie={};function ue(t,e){return t instanceof Map?t.has(e):Object.prototype.hasOwnProperty.call(t,e)}function gt(t,e){if(e in t){let n=Reflect.getPrototypeOf(t);for(;n;){const r=Reflect.getOwnPropertyDescriptor(n,e);if(r)return r;n=Reflect.getPrototypeOf(n)}}}function Re(t){return Object.getPrototypeOf(t)===Set.prototype}function Te(t){return Object.getPrototypeOf(t)===Map.prototype}function $(t){var e;return(e=t.copy)!==null&&e!==void 0?e:t.original}function Z(t){return!!g(t)}function g(t){return typeof t!="object"?null:t==null?void 0:t[wt]}function je(t){var e;const n=g(t);return n?(e=n.copy)!==null&&e!==void 0?e:n.original:t}function F(t,e){if(!t||typeof t!="object")return!1;let n;return Object.getPrototypeOf(t)===Object.prototype||Array.isArray(t)||t instanceof Map||t instanceof Set||!!(e!=null&&e.mark)&&((n=e.mark(t,U))===U.immutable||typeof n=="function")}function mt(t,e=[]){if(Object.hasOwnProperty.call(t,"key")){const n=t.parent.copy,r=g(K(n,t.key));if(r!==null&&(r==null?void 0:r.original)!==t.original)return null;const s=t.parent.type===3,i=s?Array.from(t.parent.setMap.keys()).indexOf(t.key):t.key;if(!(s&&n.size>i||ue(n,i)))return null;e.push(i)}if(t.parent)return mt(t.parent,e);e.reverse();try{Pn(t.copy,e)}catch{return null}return e}function ee(t){return Array.isArray(t)?1:t instanceof Map?2:t instanceof Set?3:0}function K(t,e){return ee(t)===2?t.get(e):t[e]}function fe(t,e,n){ee(t)===2?t.set(e,n):t[e]=n}function xe(t,e){const n=g(t);return(n?$(n):t)[e]}function H(t,e){return t===e?t!==0||1/t===1/e:t!==t&&e!==e}function Ue(t){if(t)for(;t.finalities.revoke.length>0;)t.finalities.revoke.pop()()}function te(t,e){return e?t:[""].concat(t).map(n=>{const r=`${n}`;return r.indexOf("/")===-1&&r.indexOf("~")===-1?r:r.replace(/~/g,"~0").replace(/\//g,"~1")}).join("/")}function Pn(t,e){for(let n=0;n<e.length-1;n+=1){const r=e[n];if(t=K(ee(t)===3?Array.from(t):t,r),typeof t!="object")throw new Error(`Cannot resolve patch at '${e.join("/")}'.`)}return t}function An(t){const e=Object.create(Object.getPrototypeOf(t));return Reflect.ownKeys(t).forEach(n=>{let r=Reflect.getOwnPropertyDescriptor(t,n);if(r.enumerable&&r.configurable&&r.writable){e[n]=t[n];return}r.writable||(r.writable=!0,r.configurable=!0),(r.get||r.set)&&(r={configurable:!0,writable:!0,enumerable:r.enumerable,value:t[n]}),Reflect.defineProperty(e,n,r)}),e}const Cn=Object.prototype.propertyIsEnumerable;function St(t,e){let n;if(Array.isArray(t))return Array.prototype.concat.call(t);if(t instanceof Set){if(!Re(t)){const r=Object.getPrototypeOf(t).constructor;return new r(t.values())}return Set.prototype.difference?Set.prototype.difference.call(t,new Set):new Set(t.values())}else if(t instanceof Map){if(!Te(t)){const r=Object.getPrototypeOf(t).constructor;return new r(t)}return new Map(t)}else if(e!=null&&e.mark&&(n=e.mark(t,U),n!==void 0)&&n!==U.mutable){if(n===U.immutable)return An(t);if(typeof n=="function"){if(e.enablePatches||e.enableAutoFreeze)throw new Error("You can't use mark and patches or auto freeze together.");return n()}throw new Error(`Unsupported mark result: ${n}`)}else if(typeof t=="object"&&Object.getPrototypeOf(t)===Object.prototype){const r={};return Object.keys(t).forEach(s=>{r[s]=t[s]}),Object.getOwnPropertySymbols(t).forEach(s=>{Cn.call(t,s)&&(r[s]=t[s])}),r}else throw new Error("Please check mark() to ensure that it is a stable marker draftable function.")}function I(t){t.copy||(t.copy=St(t.original,t.options))}function le(t){if(!F(t))return je(t);if(Array.isArray(t))return t.map(le);if(t instanceof Map){const n=Array.from(t.entries()).map(([r,s])=>[r,le(s)]);if(!Te(t)){const r=Object.getPrototypeOf(t).constructor;return new r(n)}return new Map(n)}if(t instanceof Set){const n=Array.from(t).map(le);if(!Re(t)){const r=Object.getPrototypeOf(t).constructor;return new r(n)}return new Set(n)}const e=Object.create(Object.getPrototypeOf(t));for(const n in t)e[n]=le(t[n]);return e}function be(t){return Z(t)?le(t):t}function W(t){var e;t.assignedMap=(e=t.assignedMap)!==null&&e!==void 0?e:new Map,t.operated||(t.operated=!0,t.parent&&W(t.parent))}function Ot(){throw new Error("Cannot modify frozen object")}function ie(t,e,n,r,s){{n=n??new WeakMap,r=r??[],s=s??[];const o=n.has(t)?n.get(t):t;if(r.length>0){const a=r.indexOf(o);if(o&&typeof o=="object"&&a!==-1)throw r[0]===o?new Error("Forbids circular reference"):new Error(`Forbids circular reference: ~/${s.slice(0,a).map((c,u)=>{if(typeof c=="symbol")return`[${c.toString()}]`;const f=r[u];return typeof c=="object"&&(f instanceof Map||f instanceof Set)?Array.from(f.keys()).indexOf(c):c}).join("/")}`);r.push(o),s.push(e)}else r.push(o)}if(Object.isFrozen(t)||Z(t)){r.pop(),s.pop();return}switch(ee(t)){case 2:for(const[a,c]of t)ie(a,a,n,r,s),ie(c,a,n,r,s);t.set=t.clear=t.delete=Ot;break;case 3:for(const a of t)ie(a,a,n,r,s);t.add=t.clear=t.delete=Ot;break;case 1:Object.freeze(t);let o=0;for(const a of t)ie(a,o,n,r,s),o+=1;break;default:Object.freeze(t),Object.keys(t).forEach(a=>{const c=t[a];ie(c,a,n,r,s)})}r.pop(),s.pop()}function $e(t,e){const n=ee(t);if(n===0)Reflect.ownKeys(t).forEach(r=>{e(r,t[r],t)});else if(n===1){let r=0;for(const s of t)e(r,s,t),r+=1}else t.forEach((r,s)=>e(s,r,t))}function vt(t,e,n){if(Z(t)||!F(t,n)||e.has(t)||Object.isFrozen(t))return;const r=t instanceof Set,s=r?new Map:void 0;if(e.add(t),$e(t,(i,o)=>{var a;if(Z(o)){const c=g(o);I(c);const u=!((a=c.assignedMap)===null||a===void 0)&&a.size||c.operated?c.copy:c.original;fe(r?s:t,i,u)}else vt(o,e,n)}),s){const i=t,o=Array.from(i);i.clear(),o.forEach(a=>{i.add(s.has(a)?s.get(a):a)})}}function kn(t,e){const n=t.type===3?t.setMap:t.copy;t.finalities.revoke.length>1&&t.assignedMap.get(e)&&n&&vt(K(n,e),t.finalities.handledSet,t.options)}function De(t){t.type===3&&t.copy&&(t.copy.clear(),t.setMap.forEach(e=>{t.copy.add(je(e))}))}function Ne(t,e,n,r){if(t.operated&&t.assignedMap&&t.assignedMap.size>0&&!t.finalized){if(n&&r){const i=mt(t);i&&e(t,i,n,r)}t.finalized=!0}}function Le(t,e,n,r){const s=g(n);s&&(s.callbacks||(s.callbacks=[]),s.callbacks.push((i,o)=>{var a;const c=t.type===3?t.setMap:t.copy;if(H(K(c,e),n)){let u=s.original;s.copy&&(u=s.copy),De(t),Ne(t,r,i,o),t.options.enableAutoFreeze&&(t.options.updatedValues=(a=t.options.updatedValues)!==null&&a!==void 0?a:new WeakMap,t.options.updatedValues.set(u,s.original)),fe(c,e,u)}}),t.options.enableAutoFreeze&&s.finalities!==t.finalities&&(t.options.enableAutoFreeze=!1)),F(n,t.options)&&t.finalities.draft.push(()=>{const i=t.type===3?t.setMap:t.copy;H(K(i,e),n)&&kn(t,e)})}function En(t,e,n,r,s){let{original:i,assignedMap:o,options:a}=t,c=t.copy;c.length<i.length&&([i,c]=[c,i],[n,r]=[r,n]);for(let u=0;u<i.length;u+=1)if(o.get(u.toString())&&c[u]!==i[u]){const f=e.concat([u]),l=te(f,s);n.push({op:P.Replace,path:l,value:be(c[u])}),r.push({op:P.Replace,path:l,value:be(i[u])})}for(let u=i.length;u<c.length;u+=1){const f=e.concat([u]),l=te(f,s);n.push({op:P.Add,path:l,value:be(c[u])})}if(i.length<c.length){const{arrayLengthAssignment:u=!0}=a.enablePatches;if(u){const f=e.concat(["length"]),l=te(f,s);r.push({op:P.Replace,path:l,value:i.length})}else for(let f=c.length;i.length<f;f-=1){const l=e.concat([f-1]),d=te(l,s);r.push({op:P.Remove,path:d})}}}function In({original:t,copy:e,assignedMap:n},r,s,i,o){n.forEach((a,c)=>{const u=K(t,c),f=be(K(e,c)),l=a?ue(t,c)?P.Replace:P.Add:P.Remove;if(H(u,f)&&l===P.Replace)return;const d=r.concat(c),h=te(d,o);s.push(l===P.Remove?{op:l,path:h}:{op:l,path:h,value:f}),i.push(l===P.Add?{op:P.Remove,path:h}:l===P.Remove?{op:P.Add,path:h,value:u}:{op:P.Replace,path:h,value:u})})}function Rn({original:t,copy:e},n,r,s,i){let o=0;t.forEach(a=>{if(!e.has(a)){const c=n.concat([o]),u=te(c,i);r.push({op:P.Remove,path:u,value:a}),s.unshift({op:P.Add,path:u,value:a})}o+=1}),o=0,e.forEach(a=>{if(!t.has(a)){const c=n.concat([o]),u=te(c,i);r.push({op:P.Add,path:u,value:a}),s.unshift({op:P.Remove,path:u,value:a})}o+=1})}function de(t,e,n,r){const{pathAsArray:s=!0}=t.options.enablePatches;switch(t.type){case 0:case 2:return In(t,e,n,r,s);case 1:return En(t,e,n,r,s);case 3:return Rn(t,e,n,r,s)}}const _e=(t,e,n=!1)=>{if(typeof t=="object"&&t!==null&&(!F(t,e)||n))throw new Error("Strict mode: Mutable data cannot be accessed directly, please use 'unsafe(callback)' wrap.")},qe={get size(){return $(g(this)).size},has(t){return $(g(this)).has(t)},set(t,e){const n=g(this),r=$(n);return(!r.has(t)||!H(r.get(t),e))&&(I(n),W(n),n.assignedMap.set(t,!0),n.copy.set(t,e),Le(n,t,e,de)),this},delete(t){if(!this.has(t))return!1;const e=g(this);return I(e),W(e),e.original.has(t)?e.assignedMap.set(t,!1):e.assignedMap.delete(t),e.copy.delete(t),!0},clear(){const t=g(this);if(this.size){I(t),W(t),t.assignedMap=new Map;for(const[e]of t.original)t.assignedMap.set(e,!1);t.copy.clear()}},forEach(t,e){const n=g(this);$(n).forEach((r,s)=>{t.call(e,this.get(s),s,this)})},get(t){var e,n;const r=g(this),s=$(r).get(t),i=((n=(e=r.options).mark)===null||n===void 0?void 0:n.call(e,s,U))===U.mutable;if(r.options.strict&&_e(s,r.options,i),i||r.finalized||!F(s,r.options)||s!==r.original.get(t))return s;const o=Ie.createDraft({original:s,parentDraft:r,key:t,finalities:r.finalities,options:r.options});return I(r),r.copy.set(t,o),o},keys(){return $(g(this)).keys()},values(){const t=this.keys();return{[ye]:()=>this.values(),next:()=>{const e=t.next();return e.done?e:{done:!1,value:this.get(e.value)}}}},entries(){const t=this.keys();return{[ye]:()=>this.entries(),next:()=>{const e=t.next();if(e.done)return e;const n=this.get(e.value);return{done:!1,value:[e.value,n]}}}},[ye](){return this.entries()}},Tn=Reflect.ownKeys(qe),Mt=(t,e,{isValuesIterator:n})=>()=>{var r,s;const i=e.next();if(i.done)return i;const o=i.value;let a=t.setMap.get(o);const c=g(a),u=((s=(r=t.options).mark)===null||s===void 0?void 0:s.call(r,a,U))===U.mutable;if(t.options.strict&&_e(o,t.options,u),!u&&!c&&F(o,t.options)&&!t.finalized&&t.original.has(o)){const f=Ie.createDraft({original:o,parentDraft:t,key:o,finalities:t.finalities,options:t.options});t.setMap.set(o,f),a=f}else c&&(a=c.proxy);return{done:!1,value:n?a:[a,a]}},we={get size(){return g(this).setMap.size},has(t){const e=g(this);if(e.setMap.has(t))return!0;I(e);const n=g(t);return!!(n&&e.setMap.has(n.original))},add(t){const e=g(this);return this.has(t)||(I(e),W(e),e.assignedMap.set(t,!0),e.setMap.set(t,t),Le(e,t,t,de)),this},delete(t){if(!this.has(t))return!1;const e=g(this);I(e),W(e);const n=g(t);return n&&e.setMap.has(n.original)?(e.assignedMap.set(n.original,!1),e.setMap.delete(n.original)):(!n&&e.setMap.has(t)?e.assignedMap.set(t,!1):e.assignedMap.delete(t),e.setMap.delete(t))},clear(){if(!this.size)return;const t=g(this);I(t),W(t);for(const e of t.original)t.assignedMap.set(e,!1);t.setMap.clear()},values(){const t=g(this);I(t);const e=t.setMap.keys();return{[Symbol.iterator]:()=>this.values(),next:Mt(t,e,{isValuesIterator:!0})}},entries(){const t=g(this);I(t);const e=t.setMap.keys();return{[Symbol.iterator]:()=>this.entries(),next:Mt(t,e,{isValuesIterator:!1})}},keys(){return this.values()},[ye](){return this.values()},forEach(t,e){const n=this.values();let r=n.next();for(;!r.done;)t.call(e,r.value,r.value,this),r=n.next()}};Set.prototype.difference&&Object.assign(we,{intersection(t){return Set.prototype.intersection.call(new Set(this.values()),t)},union(t){return Set.prototype.union.call(new Set(this.values()),t)},difference(t){return Set.prototype.difference.call(new Set(this.values()),t)},symmetricDifference(t){return Set.prototype.symmetricDifference.call(new Set(this.values()),t)},isSubsetOf(t){return Set.prototype.isSubsetOf.call(new Set(this.values()),t)},isSupersetOf(t){return Set.prototype.isSupersetOf.call(new Set(this.values()),t)},isDisjointFrom(t){return Set.prototype.isDisjointFrom.call(new Set(this.values()),t)}});const jn=Reflect.ownKeys(we),Pt=new WeakSet,At={get(t,e,n){var r,s;const i=(r=t.copy)===null||r===void 0?void 0:r[e];if(i&&Pt.has(i))return i;if(e===wt)return t;let o;if(t.options.mark){const u=e==="size"&&(t.original instanceof Map||t.original instanceof Set)?Reflect.get(t.original,e):Reflect.get(t.original,e,n);if(o=t.options.mark(u,U),o===U.mutable)return t.options.strict&&_e(u,t.options,!0),u}const a=$(t);if(a instanceof Map&&Tn.includes(e)){if(e==="size")return Object.getOwnPropertyDescriptor(qe,"size").get.call(t.proxy);const u=qe[e];if(u)return u.bind(t.proxy)}if(a instanceof Set&&jn.includes(e)){if(e==="size")return Object.getOwnPropertyDescriptor(we,"size").get.call(t.proxy);const u=we[e];if(u)return u.bind(t.proxy)}if(!ue(a,e)){const u=gt(a,e);return u?"value"in u?u.value:(s=u.get)===null||s===void 0?void 0:s.call(t.proxy):void 0}const c=a[e];if(t.options.strict&&_e(c,t.options),t.finalized||!F(c,t.options))return c;if(c===xe(t.original,e)){if(I(t),t.copy[e]=Fe({original:t.original[e],parentDraft:t,key:t.type===1?Number(e):e,finalities:t.finalities,options:t.options}),typeof o=="function"){const u=g(t.copy[e]);return I(u),W(u),u.copy}return t.copy[e]}return c},set(t,e,n){var r;if(t.type===3||t.type===2)throw new Error("Map/Set draft does not support any property assignment.");let s;if(t.type===1&&e!=="length"&&!(Number.isInteger(s=Number(e))&&s>=0&&(e===0||s===0||String(s)===String(e))))throw new Error("Only supports setting array indices and the 'length' property.");const i=gt($(t),e);if(i!=null&&i.set)return i.set.call(t.proxy,n),!0;const o=xe($(t),e),a=g(o);return a&&H(a.original,n)?(t.copy[e]=n,t.assignedMap=(r=t.assignedMap)!==null&&r!==void 0?r:new Map,t.assignedMap.set(e,!1),!0):(H(n,o)&&(n!==void 0||ue(t.original,e))||(I(t),W(t),ue(t.original,e)&&H(n,t.original[e])?t.assignedMap.delete(e):t.assignedMap.set(e,!0),t.copy[e]=n,Le(t,e,n,de)),!0)},has(t,e){return e in $(t)},ownKeys(t){return Reflect.ownKeys($(t))},getOwnPropertyDescriptor(t,e){const n=$(t),r=Reflect.getOwnPropertyDescriptor(n,e);return r&&{writable:!0,configurable:t.type!==1||e!=="length",enumerable:r.enumerable,value:n[e]}},getPrototypeOf(t){return Reflect.getPrototypeOf(t.original)},setPrototypeOf(){throw new Error("Cannot call 'setPrototypeOf()' on drafts")},defineProperty(){throw new Error("Cannot call 'defineProperty()' on drafts")},deleteProperty(t,e){var n;return t.type===1?At.set.call(this,t,e,void 0,t.proxy):(xe(t.original,e)!==void 0||e in t.original?(I(t),W(t),t.assignedMap.set(e,!1)):(t.assignedMap=(n=t.assignedMap)!==null&&n!==void 0?n:new Map,t.assignedMap.delete(e)),t.copy&&delete t.copy[e],!0)}};function Fe(t){const{original:e,parentDraft:n,key:r,finalities:s,options:i}=t,o=ee(e),a={type:o,finalized:!1,parent:n,original:e,copy:null,proxy:null,finalities:s,options:i,setMap:o===3?new Map(e.entries()):void 0};(r||"key"in t)&&(a.key=r);const{proxy:c,revoke:u}=Proxy.revocable(o===1?Object.assign([],a):a,At);if(s.revoke.push(u),Pt.add(c),a.proxy=c,n){const f=n;f.finalities.draft.push((l,d)=>{var h,p;const b=g(c);let _=f.type===3?f.setMap:f.copy;const w=K(_,r),S=g(w);if(S){let M=S.original;S.operated&&(M=je(w)),De(S),Ne(S,de,l,d),f.options.enableAutoFreeze&&(f.options.updatedValues=(h=f.options.updatedValues)!==null&&h!==void 0?h:new WeakMap,f.options.updatedValues.set(M,S.original)),fe(_,r,M)}(p=b.callbacks)===null||p===void 0||p.forEach(M=>{M(l,d)})})}else{const f=g(c);f.finalities.draft.push((l,d)=>{De(f),Ne(f,de,l,d)})}return c}Ie.createDraft=Fe;function xn(t,e,n,r,s){var i;const o=g(t),a=(i=o==null?void 0:o.original)!==null&&i!==void 0?i:t,c=!!e.length;if(o!=null&&o.operated)for(;o.finalities.draft.length>0;)o.finalities.draft.pop()(n,r);const u=c?e[0]:o?o.operated?o.copy:o.original:t;return o&&Ue(o),s&&ie(u,u,o==null?void 0:o.options.updatedValues),[u,n&&c?[{op:P.Replace,path:[],value:e[0]}]:n,r&&c?[{op:P.Replace,path:[],value:a}]:r]}function Un(t,e){var n;const r={draft:[],revoke:[],handledSet:new WeakSet};let s,i;e.enablePatches&&(s=[],i=[]);const a=((n=e.mark)===null||n===void 0?void 0:n.call(e,t,U))===U.mutable||!F(t,e)?t:Fe({original:t,parentDraft:null,finalities:r,options:e});return[a,(c=[])=>{const[u,f,l]=xn(a,c,s,i,e.enableAutoFreeze);return e.enablePatches?[u,f,l]:u}]}function ze(t){const{rootDraft:e,value:n,useRawReturn:r=!1,isRoot:s=!0}=t;$e(n,(i,o,a)=>{const c=g(o);if(c&&e&&c.finalities===e.finalities){t.isContainDraft=!0;const u=c.original;if(a instanceof Set){const f=Array.from(a);a.clear(),f.forEach(l=>a.add(i===l?u:l))}else fe(a,i,u)}else typeof o=="object"&&o!==null&&(t.value=o,t.isRoot=!1,ze(t))}),s&&(t.isContainDraft||console.warn("The return value does not contain any draft, please use 'rawReturn()' to wrap the return value to improve performance."),r&&console.warn("The return value contains drafts, please don't use 'rawReturn()' to wrap the return value."))}function Ct(t){var e;const n=g(t);if(!F(t,n==null?void 0:n.options))return t;const r=ee(t);if(n&&!n.operated)return n.original;let s;function i(){s=r===2?Te(t)?new Map(t):new(Object.getPrototypeOf(t)).constructor(t):r===3?Array.from(n.setMap.values()):St(t,n==null?void 0:n.options)}if(n){n.finalized=!0;try{i()}finally{n.finalized=!1}}else s=t;if($e(s,(o,a)=>{if(n&&H(K(n.original,o),a))return;const c=Ct(a);c!==a&&(s===t&&i(),fe(s,o,c))}),r===3){const o=(e=n==null?void 0:n.original)!==null&&e!==void 0?e:s;return Re(o)?new Set(s):new(Object.getPrototypeOf(o)).constructor(s)}return s}function kt(t){if(!Z(t))throw new Error(`current() is only used for Draft, parameter: ${t}`);return Ct(t)}const Ve=(t=>function e(n,r,s){var i,o,a;if(typeof n=="function"&&typeof r!="function")return function(m,...j){return e(m,L=>n.call(this,L,...j),r)};const c=n,u=r;let f=s;if(typeof r!="function"&&(f=r),f!==void 0&&Object.prototype.toString.call(f)!=="[object Object]")throw new Error(`Invalid options: ${f}, 'options' should be an object.`);f=Object.assign(Object.assign({},t),f);const l=Z(c)?kt(c):c,d=Array.isArray(f.mark)?(m,j)=>{for(const L of f.mark){if(typeof L!="function")throw new Error(`Invalid mark: ${L}, 'mark' should be a function.`);const J=L(m,j);if(J)return J}}:f.mark,h=(i=f.enablePatches)!==null&&i!==void 0?i:!1,p=(o=f.strict)!==null&&o!==void 0?o:!1,_={enableAutoFreeze:(a=f.enableAutoFreeze)!==null&&a!==void 0?a:!1,mark:d,strict:p,enablePatches:h};if(!F(l,_)&&typeof l=="object"&&l!==null)throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");const[w,S]=Un(l,_);if(typeof r!="function"){if(!F(l,_))throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");return[w,S]}let M;try{M=u(w)}catch(m){throw Ue(g(w)),m}const q=m=>{const j=g(w);if(!Z(m)){if(m!==void 0&&!H(m,w)&&(j!=null&&j.operated))throw new Error("Either the value is returned as a new non-draft value, or only the draft is modified without returning any value.");const J=m==null?void 0:m[Mn];if(J){const yt=J[0];return _.strict&&typeof m=="object"&&m!==null&&ze({rootDraft:j,value:m,useRawReturn:!0}),S([yt])}if(m!==void 0)return typeof m=="object"&&m!==null&&ze({rootDraft:j,value:m}),S([m])}if(m===w||m===void 0)return S([]);const L=g(m);if(_===L.options){if(L.operated)throw new Error("Cannot return a modified child draft.");return S([kt(m)])}return S([m])};return M instanceof Promise?M.then(q,m=>{throw Ue(g(w)),m}):q(M)})();Object.prototype.constructor.toString();function Et(t,e){const n=Object.keys(t),r=Object.keys(e);return n.length===r.length&&Object.keys(t).every(s=>e.hasOwnProperty(s))}function It(t,e){return Object.keys(t).length===Object.keys(e).length&&Object.keys(t).every(n=>e.hasOwnProperty(n)&&t[n]===e[n])}function ge(t,e){return typeof t!="object"||typeof e!="object"||t===null||e===null?t===e:Et(t,e)?Object.keys(t).every(n=>ge(t[n],e[n])):!1}function Rt(t){if(!he(t))return t;const e={};for(const[n,r]of Object.entries(t))r!==void 0&&(e[n]=r);return e}function Tt(t,e){if(!he(t)||!he(e))return e;const n={...t};for(const r of Object.keys(e)){if(e[r]===void 0)continue;if(e[r]===null){delete n[r];continue}const s=he(t[r])&&he(e[r]);n[r]=s?Tt(t[r],e[r]):e[r]}return n}function he(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function $n(t,e,n){if(!t||e.length===0)return;let r=t||{};for(let i=0;i<e.length-1;i++){const o=e[i];(!(o in r)||typeof r[o]!="object")&&(r[o]=typeof e[i+1]=="number"?[]:{}),r=r[o]}const s=e[e.length-1];Array.isArray(r)&&typeof s=="number"?r.splice(s,0,n):r[s]=n}function jt(t,e,n){if(!t||e.length===0)return;let r=t||{};for(let s=0;s<e.length-1;s++){const i=e[s];(!(i in r)||typeof r[i]!="object")&&(r[i]=typeof e[s+1]=="number"?[]:{}),r=r[i]}r[e[e.length-1]]=n}function xt(t,e){if(!t||e.length===0)return;const[n,...r]=e;if(n in t){if(r.length===0){Array.isArray(t)?t.splice(n,1):delete t[n];return}xt(t[n],r),Dn(t[n])&&delete t[n]}}function Dn(t){return t&&Object.keys(t).length===0}function Nn(t){return t.cardinality==="one"}function We(t){return t["value-type"]==="ref"}function Qe(t){return t["value-type"]==="blob"}function me(t,e){return t[e]}function Be(t,e){return e.reduce((n,r)=>n&&n.get(r),t)}function z(t,e){if(e.length===0)throw new Error("path must have at least one element");if(e.length===1){t.delete(e[0]);return}const[n,...r]=e;t.has(n)&&z(t.get(n),r)}function T(t,e,n){if(e.length===0)throw new Error("path must have at least one element");if(e.length===1){t.set(e[0],n);return}const[r,...s]=e;let i=t.get(r);i||(i=new Map,t.set(r,i)),T(i,s,n)}function Ut(t,e){const n=new Map,r=new Map,s=new Map;for(const i of e){const[o,a,c,u]=i,f=me(t,a);if(!f){console.warn("no such attr",o,t);continue}We(f)&&T(s,[c,a,o],i),T(n,[o,a,c],i),T(r,[a,o,c],i)}return{eav:n,aev:r,vae:s}}function $t(t){const e=new Map,n=new Map,r=new Map,s=new Map;for(const i of Object.values(t)){const o=i["forward-identity"],[a,c,u]=o,f=i["reverse-identity"];if(T(r,[c,u],i),Qe(i)&&T(e,[c,u],i),i["primary?"]&&T(n,[c],i),f){const[l,d,h]=f;T(s,[d,h],i)}}return{blobAttrs:e,primaryKeys:n,forwardIdents:r,revIdents:s}}function Ln(t){return{__type:t.__type,attrs:t.attrs,triples:D(t.eav,3),cardinalityInference:t.cardinalityInference,linkIndex:t.linkIndex}}function qn(t){return Ke(t.attrs,t.triples,t.cardinalityInference,t.linkIndex)}function Je(t){t.attrIndexes=$t(t.attrs)}function Ke(t,e,n,r){const s=Ut(t,e);return s.attrs=t,s.attrIndexes=$t(t),s.cardinalityInference=n,s.linkIndex=r,s.__type="store",s}function Se(t,e){var s,i;let n;if(Array.isArray(e[0])){const[o,a]=e[0],c=t.aev.get(o);if(!c)return null;n=(s=D(c,2).find(f=>f[2]===a))==null?void 0:s[0]}else n=e[0];if(!n)return null;const r=e[2];if(Array.isArray(r)&&r.length===2&&t.aev.get(r[0])){const[o,a]=r,c=t.aev.get(o);if(!c)return null;const f=(i=D(c,2).find(b=>b[2]===a))==null?void 0:i[0];if(!f)return null;const[l,d,h,...p]=e;return[n,d,f,...p]}else{const[o,...a]=e;return[n,...a]}}function Fn(t,e){const n=Se(t,e);if(!n)return;const[r,s,i]=n,o=me(t.attrs,s);o&&(z(t.eav,[r,s,i]),z(t.aev,[s,r,i]),We(o)&&z(t.vae,[i,s,r]))}let zn=0;function Dt(t,e,n){const[r,s,i]=n;let o;const a=Be(t.ea,[r,s,i]);return a&&(o=a[3]),o||Date.now()*10+zn++}function Vn(t,e){const n=Se(t,e);if(!n)return;const[r,s,i]=n,o=me(t.attrs,s);if(!o)return;const a=Be(t.eav,[r,s,i]),c=(a==null?void 0:a[3])??Dt(t,o,n),u=[r,s,i,c];Nn(o)?(T(t.eav,[r,s],new Map([[i,u]])),T(t.aev,[s,r],new Map([[i,u]]))):(T(t.eav,[r,s,i],u),T(t.aev,[s,r,i],u)),We(o)&&T(t.vae,[i,s,r],u)}function Wn(t,e){var d;const n=Se(t,e);if(!n)return;const[r,s,i]=n,o=me(t.attrs,s);if(!o)return;if(!Qe(o))throw new Error("merge operation is not supported for links");const a=Be(t.eav,[r,s]);if(!a)return;const c=(d=a.values().next())==null?void 0:d.value;if(!c)return;const u=c[2],f=Tt(u,i),l=[r,s,f,Dt(t,o,c)];T(t.eav,[r,s],new Map([[f,l]]))}function He(t,e){var c,u;const[n,r]=e,s=Se(t,[n]);if(!s)return;const[i]=s,o=t.eav.get(i);if(o){for(const f of o.keys()){const l=t.attrs[f];l&&l["on-delete-reverse"]==="cascade"&&D(o.get(f),1).forEach(([d,h,p])=>{var b;return He(t,[p,(b=l["reverse-identity"])==null?void 0:b[1]])}),(!r||!l||((c=l["forward-identity"])==null?void 0:c[1])===r)&&(z(t.aev,[f,i]),z(t.eav,[i,f]))}o.size===0&&z(t.eav,[i])}const a=t.vae.get(i)&&D(t.vae.get(i),2);a&&a.forEach(f=>{var b,_;const[l,d,h]=f,p=t.attrs[d];(!r||!p||((b=p["reverse-identity"])==null?void 0:b[1])===r)&&(z(t.eav,[l,d,h]),z(t.aev,[d,l,h]),z(t.vae,[h,d,l])),p&&p["on-delete"]==="cascade"&&He(t,[l,(_=p["forward-identity"])==null?void 0:_[1]])}),((u=t.vae.get(i))==null?void 0:u.size)===0&&z(t.vae,[i])}function Nt(t,e){const n=Ut(t.attrs,e);Object.keys(n).forEach(r=>{t[r]=n[r]})}function Qn(t,[e]){t.attrs[e.id]=e,Je(t)}function Lt(t){return D(t.eav,3)}function Bn(t,[e]){if(!t.attrs[e])return;const n=Lt(t).filter(([r,s])=>s!==e);delete t.attrs[e],Je(t),Nt(t,n)}function Jn(t,[e]){const n=t.attrs[e.id];n&&(t.attrs[e.id]={...n,...e},Je(t),Nt(t,Lt(t)))}function Kn(t,e){const[n,...r]=e;switch(n){case"add-triple":Vn(t,r);break;case"deep-merge-triple":Wn(t,r);break;case"retract-triple":Fn(t,r);break;case"delete-entity":He(t,r);break;case"add-attr":Qn(t,r);break;case"delete-attr":Bn(t,r);break;case"update-attr":Jn(t,r);break;case"rule-params":break;default:throw new Error(`unhandled transaction action: ${n}`)}}function D(t,e,n=[]){if(!t||e===0)return n;if(e===1){for(const r of t.values())n.push(r);return n}for(const r of t.values())D(r,e-1,n);return n}function Oe(t,e,n){var i,o;const r=[];if(n!=null&&n.hasOwnProperty("$not")){for(const a of e.keys())n.$not!==a&&r.push(e.get(a));return r}if(n!=null&&n.hasOwnProperty("$isNull")){const{attrId:a,isNull:c,reverse:u}=n.$isNull;if(u)for(const f of e.keys()){const l=t.vae.get(f),d=!l||((i=l.get(a))==null?void 0:i.get(null))||!l.get(a);(c?d:!d)&&r.push(e.get(f))}else{const f=t.aev.get(a);for(const l of e.keys()){const d=!f||((o=f.get(l))==null?void 0:o.get(null))||!f.get(l);(c?d:!d)&&r.push(e.get(l))}}return r}if(n!=null&&n.$comparator)return D(e,1).filter(n.$op);const s=n.in||n.$in||[n];for(const a of s){const c=e.get(a);c&&r.push(c)}return r}function Hn(t,e,n){let r="";return t!==void 0&&(r+="e"),e!==void 0&&(r+="a"),n!==void 0&&(r+="v"),r}function Gn(t,[e,n,r]){var i,o;switch(Hn(e,n,r)){case"e":{const a=t.eav.get(e);return D(a,2)}case"ea":{const a=(i=t.eav.get(e))==null?void 0:i.get(n);return D(a,1)}case"eav":{const a=(o=t.eav.get(e))==null?void 0:o.get(n);return a?Oe(t,a,r):[]}case"ev":{const a=t.eav.get(e);if(!a)return[];const c=[];for(const u of a.values())c.push(...Oe(t,u,r));return c}case"a":{const a=t.aev.get(n);return D(a,2)}case"av":{const a=t.aev.get(n);if(!a)return[];const c=[];for(const u of a.values())c.push(...Oe(t,u,r));return c}case"v":{const a=[];for(const c of t.eav.values())for(const u of c.values())a.push(...Oe(t,u,r))}default:return D(t.eav,3)}}function Yn(t,e,n){var s;const r={};for(const[i,o]of e.entries()){const a=(s=t.eav.get(n))==null?void 0:s.get(o.id),c=D(a,1);for(const u of c)r[i]=u[2]}return r}function oe(t,e,n){var r;return(r=t.attrIndexes.forwardIdents.get(e))==null?void 0:r.get(n)}function qt(t,e,n){var r;return(r=t.attrIndexes.revIdents.get(e))==null?void 0:r.get(n)}function Xn(t,e){return t.attrIndexes.blobAttrs.get(e)}function Zn(t,e){var r;const n=t.attrIndexes.primaryKeys.get(e);return n||((r=t.attrIndexes.forwardIdents.get(e))==null?void 0:r.get("id"))}function Ft(t,e){return Ve(t,n=>{e.forEach(r=>{Kn(n,r)})})}function er(t){return typeof t=="string"&&t.startsWith("?")}function tr(t,e,n){if(n.hasOwnProperty(t)){const r=n[t];return Vt(r,e,n)}return{...n,[t]:e}}function zt(t,e,n){return t===e?n:null}function nr(t){switch(typeof t){case"string":return t.startsWith("?")?tr:zt;default:return zt}}const rr=["in","$in","$not","$isNull","$comparator"];function sr(t){for(const e of rr)if(t.hasOwnProperty(e))return!0;return!1}function Vt(t,e,n){return n?typeof t=="object"?sr(t)?n:null:nr(t)(t,e,n):null}function ir(t,e,n){return t.reduce((r,s,i)=>{const o=e[i];return Vt(s,o,r)},n)}function or(t,e,n){return ur(t,e,n).map(r=>ir(e,r,n)).filter(r=>r)}function ar(t,e,n){return e.or?e.or.patterns.flatMap(r=>Ge(t,r,n)):e.and?e.and.patterns.reduce((r,s)=>Ge(t,s,r),n):n.flatMap(r=>or(t,e,r))}function Ge(t,e,n=[{}]){return e.reduce((r,s)=>ar(t,s,r),n)}function Ye(t,e){return Array.isArray(e)?e.map(n=>Ye(t,n)):er(e)?t[e]:e}function cr(t,{find:e,where:n}){return Ge(t,n).map(s=>Ye(s,e))}function ur(t,e,n){return Gn(t,Ye(n,e))}let ve;const fr=new Uint8Array(16);function lr(){if(!ve&&(ve=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ve))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ve(fr)}const C=[];for(let t=0;t<256;++t)C.push((t+256).toString(16).slice(1));function dr(t,e=0){return C[t[e+0]]+C[t[e+1]]+C[t[e+2]]+C[t[e+3]]+"-"+C[t[e+4]]+C[t[e+5]]+"-"+C[t[e+6]]+C[t[e+7]]+"-"+C[t[e+8]]+C[t[e+9]]+"-"+C[t[e+10]]+C[t[e+11]]+C[t[e+12]]+C[t[e+13]]+C[t[e+14]]+C[t[e+15]]}const Wt={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function hr(t,e,n){if(Wt.randomUUID&&!t)return Wt.randomUUID();t=t||{};const r=t.random||(t.rng||lr)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,dr(r)}function Qt(t){const e=t.replace(/-/g,""),n=[];for(let r=0;r<e.length;r+=2)n.push(parseInt(e.substring(r,r+2),16));return n}function pr(t,e){for(let n=0;n<t.length;n++){if(t[n]<e[n])return-1;if(t[n]>e[n])return 1}return 0}function yr(t,e){return pr(Qt(t),Qt(e))}function k(){return hr()}let br=0;function pe(t){return Me(`_${t}`,br++)}function Me(t,e){return`?${t}-${e}`}class ae extends Error{constructor(e){super(e),this.name="AttrNotFoundError"}}function _r(t,e){const n=Zn(t,e);if(!n)throw new ae(`Could not find id attr for ${e}`);return n}function Bt(t,e,n,r){return[wr(t,e,n,r)]}function wr(t,e,n,r){return[t(n,r),_r(e,n).id,t(n,r),t("time",r)]}function gr(t,e,n){return t.map(r=>r===e?n:r)}function Jt(t,e,n,r,s){const i=oe(e,n,s),o=qt(e,n,s),a=i||o;if(!a)throw new ae(`Could not find attr for ${[n,s]}`);if(a["value-type"]!=="ref")throw new Error(`Attr ${a.id} is not a ref`);const[c,u]=a["forward-identity"],[f,l]=a["reverse-identity"],d=r+1,h=i?[t(u,r),a.id,t(l,d),pe("time")]:[t(u,d),a.id,t(l,r),pe("time")];return[i?l:u,d,h,a,!!i]}function Kt(t,e){if(typeof e!="string")return function(o){return!1};const r=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/%/g,".*").replace(/_/g,"."),s=new RegExp(`^${r}$`,t?void 0:"i");return function(o){return typeof o!="string"?!1:s.test(o)}}function mr(t,e){if(typeof e!="object"||e.hasOwnProperty("$in")||e.hasOwnProperty("in"))return e;const n=t["checked-data-type"]==="date";if(e.hasOwnProperty("$gt"))return{$comparator:!0,$op:n?function(s){return new Date(s[2])>new Date(e.$gt)}:function(s){return s[2]>e.$gt}};if(e.hasOwnProperty("$gte"))return{$comparator:!0,$op:n?function(s){return new Date(s[2])>=new Date(e.$gte)}:function(s){return s[2]>=e.$gte}};if(e.hasOwnProperty("$lt"))return{$comparator:!0,$op:n?function(s){return new Date(s[2])<new Date(e.$lt)}:function(s){return s[2]<e.$lt}};if(e.hasOwnProperty("$lte"))return{$comparator:!0,$op:n?function(s){return new Date(s[2])<=new Date(e.$lte)}:function(s){return s[2]<=e.$lte}};if(e.hasOwnProperty("$like")){const r=Kt(!0,e.$like);return{$comparator:!0,$op:function(i){return r(i[2])}}}if(e.hasOwnProperty("$ilike")){const r=Kt(!1,e.$ilike);return{$comparator:!0,$op:function(i){return r(i[2])}}}return e}function Sr(t,e,n,r,s,i){const o=oe(e,n,s),a=qt(e,n,s),c=o||a;if(!c)throw new ae(`No attr for etype = ${n} label = ${s}`);if(i!=null&&i.hasOwnProperty("$isNull")){const u=oe(e,n,"id");if(!u)throw new ae(`No attr for etype = ${n} label = id`);return[t(n,r),u.id,{$isNull:{attrId:c.id,isNull:i.$isNull,reverse:!o}},pe("time")]}return o?[t(n,r),c.id,mr(c,i),pe("time")]:[i,c.id,t(n,r),pe("time")]}function Or(t,e,n,r,s){const[i,o,a]=s.reduce((c,u)=>{const[f,l,d]=c,[h,p,b]=Jt(t,e,f,l,u);return[h,p,[...d,b]]},[n,r,[]]);return[i,o,a]}function Xe(t,e,n,r,s,i){const o=s.slice(0,s.length-1),a=s[s.length-1],[c,u,f]=Or(t,e,n,r,o),l=Sr(t,e,c,u,a,i);return f.concat([l])}function vr(t,e){return e?[e].concat(t):t}function Mr([t,e]){return t==="or"&&Array.isArray(e)}function Pr([t,e]){return t==="and"&&Array.isArray(e)}function Ar(t,e,n){return(r,s)=>{const i=t(r,s);return e==i?i:`${i}-${n}`}}function Ht(t,e,n,r,s,i){const o=t(r,s),a=i.map((c,u)=>{const f=Ar(t,o,u);return Yt(f,n,r,s,c)});return{[e]:{patterns:a,joinSym:o}}}function Cr(t){const e=[];for(let n=1;n<=t.length;n++)e.push(t.slice(0,n));return e}function Gt(t,e,n,r,s){return Cr(s).map(i=>Xe(t,e,n,r,i,{$isNull:!0}))}function Yt(t,e,n,r,s){return Object.entries(s).flatMap(([i,o])=>{if(Mr([i,o]))return Ht(t,"or",e,n,r,o);if(Pr([i,o]))return Ht(t,"and",e,n,r,o);if(i==="$entityIdStartsWith")return[];const a=i.split(".");if(o!=null&&o.hasOwnProperty("$not")){const c=Xe(t,e,n,r,a,o),u=Gt(t,e,n,r,a);return[{or:{patterns:[c,...u],joinSym:t(n,r)}}]}return o!=null&&o.hasOwnProperty("$isNull")&&o.$isNull===!0&&a.length>1?[{or:{patterns:Gt(t,e,n,r,a),joinSym:t(n,r)}}]:Xe(t,e,n,r,a,o)})}function kr(t,e,n,r){const s=Me;return r?Yt(s,t,e,n,r).concat(Bt(s,t,e,n)):Bt(s,t,e,n)}function Er(t,e,n){return[t(e,n),t("time",n)]}function Ir(t,e,n,r,s,i){const[o,a,c,u,f]=Jt(t,e,n,r,s),l=gr(c,t(n,r),i);return[o,a,l,u,f]}function Rr(t,e,{etype:n,level:r,form:s},i){const o=Object.keys(s).filter(a=>a!=="$");return o.length?Object.entries(i).map(function([c,u]){return o.map(function(d){var p,b,_;const h=!!(e.cardinalityInference&&((_=(b=(p=e.linkIndex)==null?void 0:p[n])==null?void 0:b[d])!=null&&_.isSingular));try{const[w,S,M]=Ir(t,e,n,r,d,c),q=Xt(e,{etype:w,level:S,form:s[d],join:M}),m=h?q[0]:q;return{[d]:m}}catch(w){if(w instanceof ae)return{[d]:h?void 0:[]};throw w}}).reduce(function(d,h){return{...d,...h}},u)}):Object.values(i)}function Pe([t,e],[n,r]){return e===r||e==null&&r==null?yr(t,n):r==null?1:e==null?-1:e>r?1:-1}function Ze(t){return t==null?t:new Date(t).getTime()}function Tr(t,e,n,r){var h;const[s,i,o,a]=t,c=n==="desc"?1:-1;if(((h=e["forward-identity"])==null?void 0:h[2])==="id")return Pe(r,[s,a])===c;const[u,f]=r,l=e["checked-data-type"]==="date"?Ze(f):f,d=e["checked-data-type"]==="date"?Ze(o):o;return Pe([u,l],[s,d])===c}function jr(t,e){const n=e[1];return t.attrs[n]}function xr(t,e,n){const r=Object.keys(n)[0];return oe(t,e,r)}function Ur(t,e,n,r){if(n)return jr(t,n);if(r)return xr(t,e,r)}function $r(t,e,n){var s,i;if(!Array.isArray(n.fields))return Xn(t,e);const r=new Map;for(const o of n.fields){const a=oe(t,e,o),c=(s=a==null?void 0:a["forward-identity"])==null?void 0:s[2];c&&Qe(a)&&r.set(c,a)}if(!r.has("id")){const o=oe(t,e,"id"),a=(i=o==null?void 0:o["forward-identity"])==null?void 0:i[2];a&&r.set(a,o)}return r}function Dr(t,e,n,r,s,i){var l;let o=cr(t,i);const a=r==null?void 0:r["start-cursor"],c=Ur(t,e,a,s);if(c&&((l=c==null?void 0:c["forward-identity"])==null?void 0:l[2])!=="id"){const d=c["checked-data-type"]==="date",h=c.id;o=o.map(([p])=>{var _,w,S,M,q;let b=(q=(M=(S=(w=(_=t.eav.get(p))==null?void 0:_.get(h))==null?void 0:w.values())==null?void 0:S.next())==null?void 0:M.value)==null?void 0:q[2];return d&&(b=Ze(b)),[p,b]})}o.sort(n==="asc"?function(h,p){return Pe(h,p)}:function(h,p){return Pe(p,h)});let u={};const f=$r(t,e,i);for(const d of o){const[h]=d;if(u[h]||a&&c&&Tr(a,c,n,d))continue;const p=Yn(t,f,h);p&&(u[h]=p)}return u}function Nr(t){var n;const e=(n=t.$)==null?void 0:n.order;return e&&e[Object.keys(e)[0]]||"asc"}function Lr(t,{etype:e,level:n,form:r,join:s,pageInfo:i}){var b,_,w,S,M,q,m,j,L;const o=((b=r.$)==null?void 0:b.limit)||((_=r.$)==null?void 0:_.first)||((w=r.$)==null?void 0:w.last),a=(S=r.$)==null?void 0:S.offset,c=(M=r.$)==null?void 0:M.before,u=(q=r.$)==null?void 0:q.after,f=(m=r.$)==null?void 0:m.order,l=(j=r.$)==null?void 0:j.fields;if((a||c||u)&&(!i||!i["start-cursor"]))return[];const d=vr(kr(t,e,n,(L=r.$)==null?void 0:L.where),s),h=Er(Me,e,n),p=Dr(t,e,Nr(r),i,f,{where:d,find:h,fields:l});if(o!=null){const J=Object.entries(p);return J.length<=o?p:Object.fromEntries(J.slice(0,o))}return p}function qr(t,e){try{return Lr(t,e)}catch(n){if(n instanceof ae)return{};throw n}}function Xt(t,e){const n=qr(t,e);return Rr(Me,t,e,n)}function Fr(t){const e={};for(const[n,r]of Object.entries(t))e[n]={startCursor:r["start-cursor"],endCursor:r["end-cursor"],hasNextPage:r["has-next-page?"],hasPreviousPage:r["has-previous-page?"]};return e}function zr({store:t,pageInfo:e,aggregate:n},r){const i={data:Object.keys(r).reduce(function(a,c){return n!=null&&n[c]||c==="$$ruleParams"||(a[c]=Xt(t,{etype:c,form:r[c],level:0,pageInfo:e==null?void 0:e[c]})),a},{})};return e&&(i.pageInfo=Fr(e)),n&&(i.aggregate=n),i}function Vr(){const e={__ops:1,update:1,link:1,unlink:1,delete:1,merge:1,ruleParams:1};return new Set(Object.keys(e))}const Wr=Vr();function et(t,e,n){return new Proxy({},{get:(r,s)=>{if(s==="__ops")return n;if(Wr.has(s))return i=>et(t,e,[...n,[s,t,e,i]])}})}function Qr(t,e){return`lookup__${t}__${JSON.stringify(e)}`}function tt(t){return t.startsWith("lookup__")}function Zt(t){const[e,n,...r]=t.split("__");return[n,JSON.parse(r.join("__"))]}function Br(t){return new Proxy({},{get(e,n){return tt(n)?et(t,Zt(n),[]):et(t,n,[])}})}function nt(){return new Proxy({},{get(t,e){return Br(e)}})}const Jr=nt();function en(t){return t.__ops}function Kr(t,e){const{attrIdMap:n,refSwapAttrIds:r}=t,s=[];for(const o of e){const a=n[o];if(a)s.push(a);else if(Array.isArray(o)&&o.length==2&&n[o[0]]){const[c,u]=o;s.push([n[c],u])}else s.push(o)}const[i]=e;if((i==="add-triple"||i==="retract-triple")&&r.has(e[2])){const o=s[1];s[1]=s[3],s[3]=o}return s}function R(t,e,n){return Object.values(t).find(r=>{const[s,i,o]=r["forward-identity"];return i===e&&o===n})}function ne(t,e,n){return Object.values(t).find(r=>{const s=r["reverse-identity"];if(!s)return!1;const[i,o,a]=s;return o===e&&a===n})}function Hr(t){if(Array.isArray(t))return t;const e=Object.entries(t);if(e.length!==1)throw new Error("lookup must be an object with a single unique attr and value.");return e[0]}function rt(t,e,n){return n.indexOf(".")!==-1&&!R(t,e,n)}function st(t){const[e,n,...r]=t.split(".");if(r.length>0||n!=="id")throw new Error(`${t} is not a valid lookup attribute.`);return e}function Gr(t,e,n){if(!rt(t,e,n))return R(t,e,n);const r=st(n),s=R(t,e,r)||ne(t,e,r);if(s&&s["value-type"]!=="ref")throw new Error(`${n} does not reference a valid link attribute.`);return s}function it(t){return typeof t=="string"&&!tt(t)?null:typeof t=="string"&&tt(t)?Zt(t):Hr(t)}function N(t,e,n){const r=it(n);if(r===null)return n;const[s,i]=r,o=Gr(t,e,s);if(!o||!o["unique?"])throw new Error(`${s} is not a unique attribute.`);return[o.id,i]}function tn(t,e,n,r){const s=N(t,e,n);return Array.isArray(s)?[["add-triple",s,R(t,e,"id").id,s]].concat(r):r}function Yr(t,[e,n,r]){const s=Object.entries(r).flatMap(([i,o])=>{const a=Array.isArray(o)?o:[o],c=R(t,e,i),u=ne(t,e,i);return a.map(f=>c?["add-triple",N(t,e,n),c.id,N(t,c["reverse-identity"][1],f)]:["add-triple",N(t,u["forward-identity"][1],f),u.id,N(t,e,n)])});return tn(t,e,n,s)}function Xr(t,[e,n,r]){const s=Object.entries(r).flatMap(([i,o])=>{const a=Array.isArray(o)?o:[o],c=R(t,e,i),u=ne(t,e,i);return a.map(f=>c?["retract-triple",N(t,e,n),c.id,N(t,c["reverse-identity"][1],f)]:["retract-triple",N(t,u["forward-identity"][1],f),u.id,N(t,e,n)])});return tn(t,e,n,s)}function Zr(t,[e,n,r]){const s=Rt(r),i=N(t,e,n);return[["id",i]].concat(Object.entries(s)).map(([a,c])=>{const u=R(t,e,a);return["add-triple",i,u.id,c]})}function es(t,[e,n]){return[["delete-entity",N(t,e,n),e]]}function ts(t,[e,n,r]){const s=Rt(r),i=N(t,e,n),o=Object.entries(s).map(([c,u])=>{const f=R(t,e,c);return["deep-merge-triple",i,f.id,u]});return[["add-triple",i,R(t,e,"id").id,i]].concat(o)}function ns(t,[e,n,r]){return[["rule-params",N(t,e,n),e,r]]}function rs(t){const[e,n,r,s]=t;if(!s)return t;const i={...s};return delete i.id,[e,n,r,i]}function ss(t,e){const[n,...r]=rs(e);switch(n){case"merge":return ts(t,r);case"update":return Zr(t,r);case"link":return Yr(t,r);case"unlink":return Xr(t,r);case"delete":return es(t,r);case"ruleParams":return ns(t,r);default:throw new Error(`unsupported action ${n}`)}}function is(t){switch(t){case"string":case"date":case"boolean":case"number":return t;default:return}}function os(t,e,n){var a,c;const r=(c=(a=t.entities[e])==null?void 0:a.attrs)==null?void 0:c[n];if(n==="id")return null;if(!r)throw new Error(`${e}.${n} does not exist in your schema`);const{unique:s,indexed:i}=r==null?void 0:r.config,o=is(r==null?void 0:r.valueType);return{"index?":i,"unique?":s,"checked-data-type":o}}function ot(t,e,n,r){const s=t?os(t,e,n):null,i=k(),a=[k(),e,n];return{id:i,"forward-identity":a,"value-type":"blob",cardinality:"one","unique?":!1,"index?":!1,isUnsynced:!0,...s||{},...r||{}}}function as(t,e,n){return Object.values(t.links).find(s=>s.forward.on===e&&s.forward.label===n||s.reverse.on===e&&s.reverse.label===n)}function cs(t,e,n){const r=as(t,e,n);if(!r)throw new Error(`Couldn't find the link ${e}.${n} in your schema`);const{forward:s,reverse:i}=r;return{"forward-identity":[k(),s.on,s.label],"reverse-identity":[k(),i.on,i.label],cardinality:s.has==="one"?"one":"many","unique?":i.has==="one"}}function nn(t,e,n,r){const s=t?cs(t,e,n):null,i=k(),o=[k(),e,n],a=[k(),n,e];return{id:i,"forward-identity":o,"reverse-identity":a,"value-type":"ref",cardinality:"many","unique?":!1,"index?":!1,isUnsynced:!0,...s||{},...r||{}}}const us=new Set(["update","merge","link","unlink"]),fs=new Set(["link","unlink"]),ls=new Set(["update","merge"]),ds=new Set(["link","unlink","update","merge","delete","ruleParams"]),at={"unique?":!0,"index?":!0},hs={...at,cardinality:"one"};function ps(t){const e=[],[n,r,s,i]=t;if(!ds.has(n))return e;const o=it(s);if(o&&e.push({etype:r,lookupPair:o}),n==="link")for(const[a,c]of Object.entries(i)){const u=Array.isArray(c)?c:[c];for(const f of u){const l=it(f);l&&e.push({etype:r,lookupPair:l,linkLabel:a})}}return e}function ys({attrs:t,schema:e},n){var u,f;const[r,s,i]=[new Set,{...t},[]];function o(l){s[l.id]=l,i.push(["add-attr",l]),r.add(l.id)}function a(l){l!=null&&l.isUnsynced&&!r.has(l.id)&&(i.push(["add-attr",l]),r.add(l.id))}function c(l,d){const h=R(s,l,d),p=ne(s,l,d);a(h),a(p),!h&&!p&&o(nn(e,l,d,hs))}for(const l of n)for(const{etype:d,lookupPair:h,linkLabel:p}of ps(l)){const b=h[0];if(p){c(d,p);const _=R(s,d,p),w=ne(s,d,p);a(_),a(w);const S=((u=_==null?void 0:_["reverse-identity"])==null?void 0:u[1])||((f=w==null?void 0:w["forward-identity"])==null?void 0:f[1])||p;if(rt(s,S,b))c(S,st(b));else{const M=R(s,S,b);M||o(ot(e,S,b,at)),a(M)}}else if(rt(s,d,b))c(d,st(b));else{const _=R(s,d,b);_||o(ot(e,d,b,at)),a(_)}}for(const l of n){const[d,h,p,b]=l;if(us.has(d)){const _=Object.keys(b);_.push("id");for(const w of _){const S=R(s,h,w);if(a(S),ls.has(d)&&(S||o(ot(e,h,w,w==="id"?{"unique?":!0}:null))),fs.has(d)){const M=ne(s,h,w);!S&&!M&&o(nn(e,h,w)),a(M)}}}}return[s,i]}function bs(t,e){const r=(Array.isArray(e)?e:[e]).flatMap(a=>en(a)),[s,i]=ys(t,r),o=r.flatMap(a=>ss(s,a));return[...i,...o]}class ct{constructor(e){this.dbName=e,this._storeName="kv",this._dbPromise=this._init()}_init(){return new Promise((e,n)=>{const r=indexedDB.open(this.dbName,1);r.onerror=s=>{n(s)},r.onsuccess=s=>{e(s.target.result)},r.onupgradeneeded=s=>{s.target.result.createObjectStore(this._storeName)}})}async getItem(e){const n=await this._dbPromise;return new Promise((r,s)=>{const a=n.transaction([this._storeName],"readonly").objectStore(this._storeName).get(e);a.onerror=c=>{s(c)},a.onsuccess=c=>{a.result?r(a.result):r(null)}})}async setItem(e,n){const r=await this._dbPromise;return new Promise((s,i)=>{const c=r.transaction([this._storeName],"readwrite").objectStore(this._storeName).put(n,e);c.onerror=u=>{i(u)},c.onsuccess=u=>{s()}})}}class ut{static async getIsOnline(){return navigator.onLine}static listen(e){const n=()=>{e(!0)},r=()=>{e(!1)};return addEventListener("online",n),addEventListener("offline",r),()=>{removeEventListener("online",n),removeEventListener("offline",r)}}}async function Q(t,e){const n=await fetch(t,e),r=await n.json();return n.status===200?Promise.resolve(r):Promise.reject({status:n.status,body:r})}function _s({apiURI:t,appId:e,email:n}){return Q(`${t}/runtime/auth/send_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,email:n})})}async function ws({apiURI:t,appId:e,email:n,code:r}){return await Q(`${t}/runtime/auth/verify_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,email:n,code:r})})}async function gs({apiURI:t,appId:e,refreshToken:n}){return await Q(`${t}/runtime/auth/verify_refresh_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,"refresh-token":n})})}async function rn({apiURI:t,appId:e,code:n,codeVerifier:r}){return await Q(`${t}/runtime/oauth/token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:e,code:n,code_verifier:r})})}async function ms({apiURI:t,appId:e,nonce:n,idToken:r,clientName:s,refreshToken:i}){return await Q(`${t}/runtime/oauth/id_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:e,nonce:n,id_token:r,client_name:s,refresh_token:i})})}async function Ss({apiURI:t,appId:e,refreshToken:n}){return await Q(`${t}/runtime/signout`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:e,refresh_token:n})})}async function Os({apiURI:t,appId:e,path:n,file:r,refreshToken:s,contentType:i,contentDisposition:o}){const a={app_id:e,path:n,authorization:`Bearer ${s}`,"content-type":i||r.type};return o&&(a["content-disposition"]=o),await Q(`${t}/storage/upload`,{method:"PUT",headers:a,body:r})}async function vs({apiURI:t,appId:e,path:n,refreshToken:r}){const{data:s}=await Q(`${t}/storage/files?app_id=${e}&filename=${encodeURIComponent(n)}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:`Bearer ${r}`}});return s}async function Ms({apiURI:t,appId:e,fileName:n,refreshToken:r,metadata:s={}}){const{data:i}=await Q(`${t}/storage/signed-upload-url`,{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${r}`},body:JSON.stringify({app_id:e,filename:n})});return i}async function Ps(t,e){return(await fetch(t,{method:"PUT",body:e,headers:{"Content-Type":e.type}})).ok}async function As({apiURI:t,appId:e,path:n,refreshToken:r}){const{data:s}=await Q(`${t}/storage/signed-download-url?app_id=${e}&filename=${encodeURIComponent(n)}`,{method:"GET",headers:{"content-type":"application/json",authorization:`Bearer ${r}`}});return s}function sn(t,e){if(!e)return t;const n={};return e.forEach(r=>{n[r]=t[r]}),n}function Cs(t,e,n){const r={peers:{}};if(e&&"user"in e?e.user:!0){const i=sn(t.user??{},e==null?void 0:e.keys);r.user={...i,peerId:n}}for(const i of Object.keys(t.peers??{})){const o=(e==null?void 0:e.peers)===void 0,a=Array.isArray(e==null?void 0:e.peers)&&(e==null?void 0:e.peers.includes(i));if(o||a){const c=sn(t.peers[i],e==null?void 0:e.keys);r.peers[i]={...c,peerId:i}}}return r}function ks(t,e){if(t.isLoading!==e.isLoading||t.error!==e.error||(t.user||e.user)&&(!t.user||!e.user||!It(t.user,e.user))||!Et(t.peers,e.peers))return!0;for(const r of Object.keys(t.peers))if(!It(t.peers[r],e.peers[r]))return!0;return!1}class on{constructor(){y(this,"promise");y(this,"_resolve");y(this,"_reject");this.promise=new Promise((e,n)=>{this._resolve=e,this._reject=n})}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class an{constructor(e,n,r,s,i=c=>JSON.stringify(c),o=c=>JSON.parse(c),a=100){y(this,"_subs",[]);this._persister=e,this._key=n,this._onMerge=s,this._loadedCbs=[],this._isLoading=!0,this.currentValue=r,this.toJSON=i,this.fromJSON=o,this._saveThrottleMs=a,this._pendingSaveCbs=[],this._version=0,this._load()}async _load(){const e=this.fromJSON(await this._persister.getItem(this._key));this._isLoading=!1,this._onMerge(e,this.currentValue);for(const n of this._loadedCbs)n()}async waitForLoaded(){if(!this._isLoading)return;await new Promise(n=>{this._loadedCbs.push(n)})}isLoading(){return this._isLoading}version(){return this._version}async waitForSync(){if(!this._nextSave)return;await new Promise(n=>{this._pendingSaveCbs.push(n)})}_writeToStorage(){this._persister.setItem(this._key,this.toJSON(this.currentValue));for(const e of this._pendingSaveCbs)e();this._pendingSaveCbs.length=0}async flush(){this._nextSave&&(clearTimeout(this._nextSave),this._writeToStorage())}_enqueuePersist(e){if(this._nextSave){e&&this._pendingSaveCbs.push(e);return}this._nextSave=setTimeout(()=>{this._nextSave=null,this._writeToStorage()},this._saveThrottleMs)}set(e,n){this._version++,this.currentValue=e(this.currentValue),this._isLoading?this._loadedCbs.push(()=>this._enqueuePersist(n)):this._enqueuePersist(n);for(const r of this._subs)r(this.currentValue)}subscribe(e){return this._subs.push(e),e(this.currentValue),()=>{this._subs=this._subs.filter(n=>n!==e)}}}function cn(t,e=[]){t.forEach(n=>{const{data:r}=n,{"datalog-result":s}=r,{"join-rows":i}=s;for(const o of i)for(const a of o)e.push(a);cn(n["child-nodes"],e)})}function un(t){const e=[];return cn(t,e),e}function Es(t){return Object.values(t.links).reduce((e,n)=>{var r,s;return e[r=n.forward.on]??(e[r]={}),e[n.forward.on][n.forward.label]={isForward:!0,isSingular:n.forward.has==="one",link:n},e[s=n.reverse.on]??(e[s]={}),e[n.reverse.on][n.reverse.label]={isForward:!1,isSingular:n.reverse.has==="one",link:n},e},{})}const ft="v0.18.3",G={CONNECTING:"connecting",OPENED:"opened",AUTHENTICATED:"authenticated",CLOSED:"closed",ERRORED:"errored"},Is=3e4,Rs=0,fn=1,Ts={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"},lt="_instant_oauth_redirect",dt="currentUser";let js=0;function xs(t){const e=new WebSocket(t);return e._id=js++,e}function Us(){return typeof window<"u"||typeof chrome<"u"}const ln={"set-presence":!0,"set-presence-ok":!0,"refresh-presence":!0,"patch-presence":!0};function $s(t){var n;const e=JSON.parse(t);for(const r in e){const s=e[r];(n=s==null?void 0:s.result)!=null&&n.store&&(s.result.store=qn(s.result.store))}return e}function Ds(t){var n;const e={};for(const r in t){const s=t[r],i={...s};(n=s.result)!=null&&n.store&&(i.result={...s.result,store:Ln(s.result.store)}),e[r]=i}return JSON.stringify(e)}class Ns{constructor(e,n=ct,r=ut,s){y(this,"attrs");y(this,"_isOnline",!0);y(this,"_isShutdown",!1);y(this,"status",G.CONNECTING);y(this,"querySubs");y(this,"pendingMutations");y(this,"queryCbs",{});y(this,"queryOnceDfds",{});y(this,"authCbs",[]);y(this,"attrsCbs",[]);y(this,"mutationErrorCbs",[]);y(this,"connectionStatusCbs",[]);y(this,"config");y(this,"_persister");y(this,"mutationDeferredStore",new Map);y(this,"_reconnectTimeoutId",null);y(this,"_reconnectTimeoutMs",0);y(this,"_ws");y(this,"_localIdPromises",{});y(this,"_errorMessage",null);y(this,"_oauthCallbackResponse",null);y(this,"_linkIndex",null);y(this,"_broadcastChannel");y(this,"_rooms",{});y(this,"_roomsPendingLeave",{});y(this,"_presence",{});y(this,"_broadcastQueue",[]);y(this,"_broadcastSubs",{});y(this,"_currentUserCached",{isLoading:!0,error:void 0,user:void 0});y(this,"_beforeUnloadCbs",[]);y(this,"_dataForQueryCache",{});y(this,"_onMergeQuerySubs",(e,n)=>{const r=e||{},s={...n};Object.entries(n).forEach(([o,a])=>{var f;const c=(f=r==null?void 0:r[o])==null?void 0:f.result,u=a.result;c&&!u&&(s[o].result=c)}),Object.keys(r).filter(o=>!n[o]).slice(0,10).forEach(o=>{s[o]=r[o]}),this.querySubs.set(o=>s),this.loadedNotifyAll()});y(this,"_onMergePendingMutations",(e,n)=>{const r=new Map([...e.entries(),...n.entries()]);this.pendingMutations.set(i=>r),this.loadedNotifyAll(),this._rewriteMutations(this.attrs,e).forEach((i,o)=>{!n.has(o)&&!i["tx-id"]&&this._sendMutation(o,i)})});y(this,"getPreviousResult",e=>{const n=x(e);return this.dataForQuery(n)});y(this,"notifyOne",e=>{var i;const n=this.queryCbs[e]??[],r=(i=this._dataForQueryCache[e])==null?void 0:i.data,s=this.dataForQuery(e);s&&(ge(s,r)||n.forEach(o=>o.cb(s)))});y(this,"notifyOneQueryOnce",e=>{const n=this.queryOnceDfds[e]??[],r=this.dataForQuery(e);n.forEach(s=>{this._completeQueryOnce(s.q,e,s.dfd),s.dfd.resolve(r)})});y(this,"notifyQueryError",(e,n)=>{(this.queryCbs[e]||[]).forEach(s=>s.cb({error:n}))});y(this,"pushTx",e=>{try{const n=bs({attrs:this.optimisticAttrs(),schema:this.config.schema},e);return this.pushOps(n)}catch(n){return this.pushOps([],n)}});y(this,"pushOps",(e,n)=>{const r=k(),s={op:"transact","tx-steps":e,error:n};this.pendingMutations.set(o=>(o.set(r,s),o));const i=new on;return this.mutationDeferredStore.set(r,i),this._sendMutation(r,s),this.notifyAll(),i.promise});y(this,"_wsOnOpen",e=>{const n=e.target;if(this._ws!==n){A.info("[socket][open]",n._id,"skip; this is no longer the current ws");return}A.info("[socket][open]",this._ws._id),this._setStatus(G.OPENED),this.getCurrentUser().then(r=>{var s;this._trySend(k(),{op:"init","app-id":this.config.appId,"refresh-token":(s=r.user)==null?void 0:s.refresh_token,versions:this.versions,"__admin-token":this.config.__adminToken})})});y(this,"_wsOnMessage",e=>{const n=e.target,r=JSON.parse(e.data.toString());if(this._ws!==n){A.info("[socket][message]",n._id,r,"skip; this is no longer the current ws");return}this._handleReceive(n._id,JSON.parse(e.data.toString()))});y(this,"_wsOnError",e=>{const n=e.target;if(this._ws!==n){A.info("[socket][error]",n._id,"skip; this is no longer the current ws");return}A.error("[socket][error]",n._id,e)});y(this,"_wsOnClose",e=>{const n=e.target;if(this._ws!==n){A.info("[socket][close]",n._id,"skip; this is no longer the current ws");return}this._setStatus(G.CLOSED);for(const r of Object.values(this._rooms))r.isConnected=!1;if(this._isShutdown){A.info("[socket][close]",n._id,"Reactor has been shut down and will not reconnect");return}A.info("[socket][close]",n._id,"schedule reconnect, ms =",this._reconnectTimeoutMs),setTimeout(()=>{if(this._reconnectTimeoutMs=Math.min(this._reconnectTimeoutMs+1e3,1e4),!this._isOnline){A.info("[socket][close]",n._id,"we are offline, no need to start socket");return}this._startSocket()},this._reconnectTimeoutMs)});this.config={...Ts,...e},this.versions={...s||{},"@instantdb/core":ft},this.config.schema&&(this._linkIndex=Es(this.config.schema)),Us()&&(typeof BroadcastChannel=="function"&&(this._broadcastChannel=new BroadcastChannel("@instantdb"),this._broadcastChannel.addEventListener("message",async i=>{var o;if(((o=i.data)==null?void 0:o.type)==="auth"){const a=await this.getCurrentUser();this.updateUser(a.user)}})),this._oauthCallbackResponse=this._oauthLoginInit(),this._initStorage(n),this.getCurrentUser(),r.getIsOnline().then(i=>{this._isOnline=i,this._startSocket(),r.listen(o=>{o!==this._isOnline&&(A.info("[network] online =",o),this._isOnline=o,this._isOnline?this._startSocket():(A.info("Changing status from",this.status,"to",G.CLOSED),this._setStatus(G.CLOSED)))})}),typeof addEventListener<"u"&&(this._beforeUnload=this._beforeUnload.bind(this),addEventListener("beforeunload",this._beforeUnload)))}_initStorage(e){this._persister=new e(`instant_${this.config.appId}_5`),this.querySubs=new an(this._persister,"querySubs",{},this._onMergeQuerySubs,Ds,$s),this.pendingMutations=new an(this._persister,"pendingMutations",new Map,this._onMergePendingMutations,n=>JSON.stringify([...n.entries()]),n=>new Map(JSON.parse(n))),this._beforeUnloadCbs.push(()=>{this.pendingMutations.flush(),this.querySubs.flush()})}_beforeUnload(){for(const e of this._beforeUnloadCbs)e()}_finishTransaction(e,n,r){const s=this.mutationDeferredStore.get(n);this.mutationDeferredStore.delete(n);const i=e!=="error"&&e!=="timeout";!s&&!i&&console.error("Mutation failed",{status:e,clientId:n,...r}),s&&(i?s.resolve({status:e,clientId:n}):s.reject({status:e,clientId:n,...r}))}_setStatus(e,n){this.status=e,this._errorMessage=n,this.notifyConnectionStatusSubs(e)}_flushEnqueuedRoomData(e){var s,i;const n=(i=(s=this._presence[e])==null?void 0:s.result)==null?void 0:i.user,r=this._broadcastQueue[e];if(this._broadcastQueue[e]=[],n&&this._trySetPresence(e,n),r)for(const o of r){const{topic:a,roomType:c,data:u}=o;this._tryBroadcast(e,c,a,u)}}_handleReceive(e,n){var s,i,o,a;const r=!!this.config.schema&&("cardinalityInference"in this.config?!!this.config.cardinalityInference:!0);switch(ln[n.op]||A.info("[receive]",e,n.op,n),n.op){case"init-ok":this._setStatus(G.AUTHENTICATED),this._reconnectTimeoutMs=0,this._setAttrs(n.attrs),this._flushPendingMessages(),this._sessionId=n["session-id"];for(const v of Object.keys(this._rooms))this._tryJoinRoom(v);break;case"add-query-exists":this.notifyOneQueryOnce(x(n.q));break;case"add-query-ok":const{q:c,result:u}=n,f=x(c),l=(i=(s=u==null?void 0:u[0])==null?void 0:s.data)==null?void 0:i["page-info"],d=(a=(o=u==null?void 0:u[0])==null?void 0:o.data)==null?void 0:a.aggregate,h=un(u),p=Ke(this.attrs,h,r,this._linkIndex);this.querySubs.set(v=>(v[f].result={store:p,pageInfo:l,aggregate:d},v)),this.notifyOne(f),this.notifyOneQueryOnce(f);break;case"refresh-ok":const{computations:b,attrs:_}=n;this._setAttrs(_);const w=b.map(v=>{var mn,Sn,On,vn;const Y=v["instaql-query"],V=v["instaql-result"],re=x(Y),se=un(V),bt=Ke(this.attrs,se,r,this._linkIndex),ai=(Sn=(mn=V==null?void 0:V[0])==null?void 0:mn.data)==null?void 0:Sn["page-info"],ci=(vn=(On=V==null?void 0:V[0])==null?void 0:On.data)==null?void 0:vn.aggregate;return{hash:re,store:bt,pageInfo:ai,aggregate:ci}});w.forEach(({hash:v,store:Y,pageInfo:V,aggregate:re})=>{this.querySubs.set(se=>(se[v].result={store:Y,pageInfo:V,aggregate:re},se))}),w.forEach(({hash:v})=>{this.notifyOne(v)});break;case"transact-ok":const{"client-event-id":S,"tx-id":M}=n,m=this._rewriteMutations(this.attrs,this.pendingMutations.currentValue).get(S);if(!m)break;this.pendingMutations.set(v=>(v.delete(S),v));const j=m["tx-steps"];this.querySubs.set(v=>{var Y;for(const[V,re]of Object.entries(v)){const se=(Y=re==null?void 0:re.result)==null?void 0:Y.store;if(!se)continue;const bt=Ft(se,j);v[V].result.store=bt}return v});const L=m["tx-steps"].filter(([v,...Y])=>v==="add-attr").map(([v,Y])=>Y).concat(Object.values(this.attrs));this._setAttrs(L),this._finishTransaction("synced",S);break;case"patch-presence":{const v=n["room-id"];this._patchPresencePeers(v,n.edits),this._notifyPresenceSubs(v);break}case"refresh-presence":{const v=n["room-id"];this._setPresencePeers(v,n.data),this._notifyPresenceSubs(v);break}case"server-broadcast":const J=n["room-id"],yt=n.topic;this._notifyBroadcastSubs(J,yt,n);break;case"join-room-ok":const ce=n["room-id"],_n=this._rooms[ce];if(!_n){this._roomsPendingLeave[ce]&&(this._tryLeaveRoom(ce),delete this._roomsPendingLeave[ce]);break}_n.isConnected=!0,this._notifyPresenceSubs(ce),this._flushEnqueuedRoomData(ce);break;case"join-room-error":const wn=n["room-id"],gn=this._rooms[wn];gn&&(gn.error=n.error),this._notifyPresenceSubs(wn);break;case"error":this._handleReceiveError(n);break}}_handleMutationError(e,n,r){const s=this.pendingMutations.currentValue.get(n);s&&(e!=="timeout"||!s["tx-id"])&&(this.pendingMutations.set(i=>(i.delete(n),i)),this.notifyAll(),this.notifyAttrsSubs(),this.notifyMutationErrorSubs(r),this._finishTransaction(e,n,r))}_handleReceiveError(e){var a,c,u,f,l;const n=e["client-event-id"],r=this.pendingMutations.currentValue.get(n),s={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa."};if(e.hint&&(s.hint=e.hint),r){const d={message:e.message,hint:e.hint};this._handleMutationError("error",n,d);return}if((a=e["original-event"])!=null&&a.hasOwnProperty("q")&&((c=e["original-event"])==null?void 0:c.op)==="add-query"){const d=(u=e["original-event"])==null?void 0:u.q,h=x(d);this.notifyQueryError(x(d),s),this.notifyQueryOnceError(d,h,n,s);return}if(((f=e["original-event"])==null?void 0:f.op)==="init"){if(e.type==="record-not-found"&&((l=e.hint)==null?void 0:l["record-type"])==="app-user"){this.changeCurrentUser(null);return}this._setStatus(G.ERRORED,s),this.notifyAll();return}const o={...e};delete o.message,delete o.hint,console.error(e.message,o),e.hint&&console.error(`This error comes with some debugging information. Here it is: 
`,e.hint)}notifyQueryOnceError(e,n,r,s){var o;const i=(o=this.queryOnceDfds[n])==null?void 0:o.find(a=>a.eventId===r);i&&(i.dfd.reject(s),this._completeQueryOnce(e,n,i.dfd))}_setAttrs(e){this.attrs=e.reduce((n,r)=>(n[r.id]=r,n),{}),this.notifyAttrsSubs()}_startQuerySub(e,n){const r=k();return this.querySubs.set(s=>(s[n]=s[n]||{q:e,result:null,eventId:r},s)),this._trySendAuthed(r,{op:"add-query",q:e}),r}subscribeQuery(e,n,r){r&&"ruleParams"in r&&(e={$$ruleParams:r.ruleParams,...e});const s=x(e),i=this.getPreviousResult(e);return i&&n(i),this.queryCbs[s]=this.queryCbs[s]??[],this.queryCbs[s].push({q:e,cb:n}),this._startQuerySub(e,s),()=>{this._unsubQuery(e,s,n)}}queryOnce(e,n){n&&"ruleParams"in n&&(e={$$ruleParams:n.ruleParams,...e});const r=new on;if(!this._isOnline)return r.reject(new Error("We can't run `queryOnce`, because the device is offline.")),r.promise;if(!this.querySubs)return r.reject(new Error("We can't run `queryOnce` on the backend. Use adminAPI.query instead: https://www.instantdb.com/docs/backend#query")),r.promise;const s=x(e),i=this._startQuerySub(e,s);return this.queryOnceDfds[s]=this.queryOnceDfds[s]??[],this.queryOnceDfds[s].push({q:e,dfd:r,eventId:i}),setTimeout(()=>r.reject(new Error("Query timed out")),Is),r.promise}_completeQueryOnce(e,n,r){this.queryOnceDfds[n]&&(this.queryOnceDfds[n]=this.queryOnceDfds[n].filter(s=>s.dfd!==r),this._cleanupQuery(e,n))}_unsubQuery(e,n,r){this.queryCbs[n]&&(this.queryCbs[n]=this.queryCbs[n].filter(s=>s.cb!==r),this._cleanupQuery(e,n))}_cleanupQuery(e,n){var s,i;(s=this.queryCbs[n])!=null&&s.length||(i=this.queryOnceDfds[n])!=null&&i.length||(delete this.queryCbs[n],delete this.queryOnceDfds[n],this._trySendAuthed(k(),{op:"remove-query",q:e}))}_rewriteMutations(e,n){if(!e)return n;const r=c=>{const[u,f,l]=c["forward-identity"];return R(e,f,l)},s=c=>{const[u,f,l]=c["forward-identity"];return ne(e,f,l)},i={attrIdMap:{},refSwapAttrIds:new Set},o=c=>{const u=[];for(const f of c){const[l]=f;if(l==="add-attr"){const[h,p]=f,b=r(p);if(b){i.attrIdMap[p.id]=b.id;continue}if(p["value-type"]==="ref"){const _=s(p);if(_){i.attrIdMap[p.id]=_.id,i.refSwapAttrIds.add(p.id);continue}}}const d=Kr(i,f);u.push(d)}return u},a=new Map;for(const[c,u]of n.entries())a.set(c,{...u,"tx-steps":o(u["tx-steps"])});return a}optimisticAttrs(){var o;const e=[...this.pendingMutations.currentValue.values()].flatMap(a=>a["tx-steps"]),n=new Set(e.filter(([a,c])=>a==="delete-attr").map(([a,c])=>c)),r=[];for(const[a,c]of e)if(a==="add-attr")r.push(c);else if(a==="update-attr"&&c.id&&((o=this.attrs)!=null&&o[c.id])){const u={...this.attrs[c.id],...c};r.push(u)}const s=[...Object.values(this.attrs||{}),...r].filter(a=>!n.has(a.id));return Object.fromEntries(s.map(a=>[a.id,a]))}dataForQuery(e){const n=this._errorMessage;if(n)return{error:n};if(!this.querySubs||!this.pendingMutations)return;const r=this.querySubs.version(),s=this.querySubs.currentValue,i=this.pendingMutations.version(),o=this.pendingMutations.currentValue,{q:a,result:c}=s[e]||{};if(!c)return;const u=this._dataForQueryCache[e];if(u&&r===u.querySubVersion&&i===u.pendingMutationsVersion)return u.data;const{store:f,pageInfo:l,aggregate:d}=c,p=[...this._rewriteMutations(f.attrs,o).values()].flatMap(w=>w["tx-steps"]),b=Ft(f,p),_=zr({store:b,pageInfo:l,aggregate:d},a);return this._dataForQueryCache[e]={querySubVersion:r,pendingMutationsVersion:i,data:_},_}notifyAll(){Object.keys(this.queryCbs).forEach(e=>{this.notifyOne(e)})}loadedNotifyAll(){this.pendingMutations.isLoading()||this.querySubs.isLoading()||this.notifyAll()}shutdown(){var e;this._isShutdown=!0,(e=this._ws)==null||e.close()}_sendMutation(e,n){if(n.error){this._handleMutationError("error",e,{error:n.error,message:n.error.message});return}if(this.status!==G.AUTHENTICATED){this._finishTransaction("enqueued",e);return}const r=Math.max(5e3,this.pendingMutations.currentValue.size*5e3);this._isOnline?(this._trySend(e,n),setTimeout(()=>{this._finishTransaction("pending",e)},3e3),setTimeout(()=>{this._isOnline&&this._handleMutationError("timeout",e,{message:"transaction timed out"})},r)):this._finishTransaction("enqueued",e)}_flushPendingMessages(){Object.keys(this.queryCbs).map(s=>this.querySubs.currentValue[s]).filter(s=>s).forEach(({eventId:s,q:i})=>{this._trySendAuthed(s,{op:"add-query",q:i})}),Object.values(this.queryOnceDfds).flat().forEach(({eventId:s,q:i})=>{this._trySendAuthed(s,{op:"add-query",q:i})}),this._rewriteMutations(this.attrs,this.pendingMutations.currentValue).forEach((s,i)=>{s["tx-id"]||this._sendMutation(i,s)})}_trySendAuthed(...e){this.status===G.AUTHENTICATED&&this._trySend(...e)}_trySend(e,n,r){this._ws.readyState===fn&&(ln[n.op]||A.info("[send]",this._ws._id,n.op,n),this._ws.send(JSON.stringify({"client-event-id":e,...n})))}_startSocket(){if(this._ws&&this._ws.readyState==Rs){A.info("[socket][start]",this._ws._id,"maintained as current ws, we were still in a connecting state");return}const e=this._ws;this._ws=xs(`${this.config.websocketURI}?app_id=${this.config.appId}`),this._ws.onopen=this._wsOnOpen,this._ws.onmessage=this._wsOnMessage,this._ws.onclose=this._wsOnClose,this._ws.onerror=this._wsOnError,A.info("[socket][start]",this._ws._id),(e==null?void 0:e.readyState)===fn&&(A.info("[socket][start]",this._ws._id,"close previous ws id = ",e._id),e.close())}async getLocalId(e){const n=`localToken_${e}`,r=await this._persister.getItem(n);if(r)return r;if(this._localIdPromises[n])return this._localIdPromises[n];const s=k();return this._localIdPromises[n]=this._persister.setItem(n,s).then(()=>s),this._localIdPromises[n]}_replaceUrlAfterOAuth(){if(typeof URL>"u")return;const e=new URL(window.location.href);if(e.searchParams.get(lt)){const n=e.toString();e.searchParams.delete(lt),e.searchParams.delete("code"),e.searchParams.delete("error");const r=e.pathname+(e.searchParams.size?"?"+e.searchParams:"")+e.hash;if(history.replaceState(history.state,"",r),typeof navigation=="object"&&typeof navigation.addEventListener=="function"&&typeof navigation.removeEventListener=="function"){let s=!1;const i=o=>{var a;s||(s=!0,navigation.removeEventListener("navigate",i),!o.userInitiated&&o.navigationType==="replace"&&((a=o.destination)==null?void 0:a.url)===n&&history.replaceState(history.state,"",r))};navigation.addEventListener("navigate",i)}}}async _oauthLoginInit(){var s,i,o,a;if(typeof window>"u"||typeof window.location>"u"||typeof URLSearchParams>"u")return null;const e=new URLSearchParams(window.location.search);if(!e.get(lt))return null;const n=e.get("error");if(n)return this._replaceUrlAfterOAuth(),{error:{message:n}};const r=e.get("code");if(!r)return null;this._replaceUrlAfterOAuth();try{const{user:c}=await rn({apiURI:this.config.apiURI,appId:this.config.appId,code:r});return this.setCurrentUser(c),null}catch(c){return((s=c==null?void 0:c.body)==null?void 0:s.type)==="record-not-found"&&((o=(i=c==null?void 0:c.body)==null?void 0:i.hint)==null?void 0:o["record-type"])==="app-oauth-code"&&await this._hasCurrentUser()?null:{error:{message:((a=c==null?void 0:c.body)==null?void 0:a.message)||"Error logging in."}}}}async _waitForOAuthCallbackResponse(){return await this._oauthCallbackResponse}__subscribeMutationErrors(e){return this.mutationErrorCbs.push(e),()=>{this.mutationErrorCbs=this.mutationErrorCbs.filter(n=>n!==e)}}subscribeAuth(e){this.authCbs.push(e);const n=this._currentUserCached;n.isLoading||e(this._currentUserCached);let r=!1;return this.getCurrentUser().then(s=>{r||ge(s,n)||e(s)}),()=>{r=!0,this.authCbs=this.authCbs.filter(s=>s!==e)}}async getAuth(){const{user:e,error:n}=await this.getCurrentUser();if(n)throw n;return e}subscribeConnectionStatus(e){return this.connectionStatusCbs.push(e),()=>{this.connectionStatusCbs=this.connectionStatusCbs.filter(n=>n!==e)}}subscribeAttrs(e){return this.attrsCbs.push(e),this.attrs&&e(this.attrs),()=>{this.attrsCbs=this.attrsCbs.filter(n=>n!==e)}}notifyAuthSubs(e){this.authCbs.forEach(n=>n(e))}notifyMutationErrorSubs(e){this.mutationErrorCbs.forEach(n=>n(e))}notifyAttrsSubs(){if(!this.attrs)return;const e=this.optimisticAttrs();this.attrsCbs.forEach(n=>n(e))}notifyConnectionStatusSubs(e){this.connectionStatusCbs.forEach(n=>n(e))}async setCurrentUser(e){await this._persister.setItem(dt,JSON.stringify(e))}getCurrentUserCached(){return this._currentUserCached}async getCurrentUser(){const e=await this._waitForOAuthCallbackResponse();if(e!=null&&e.error){const s={error:e.error,user:void 0};return this._currentUserCached={isLoading:!1,...s},s}const n=await this._persister.getItem(dt),r={user:JSON.parse(n),error:void 0};return this._currentUserCached={isLoading:!1,...r},r}async _hasCurrentUser(){const e=await this._persister.getItem(dt);return JSON.parse(e)!=null}async changeCurrentUser(e){var r;const{user:n}=await this.getCurrentUser();if(!ge(n,e)){await this.setCurrentUser(e),this.updateUser(e);try{(r=this._broadcastChannel)==null||r.postMessage({type:"auth"})}catch(s){console.error("Error posting message to broadcast channel",s)}}}updateUser(e){const n={error:void 0,user:e};this._currentUserCached={isLoading:!1,...n},this._dataForQueryCache={},this.querySubs.set(r=>(Object.keys(r).forEach(s=>{delete r[s].result}),r)),this._reconnectTimeoutMs=0,this._ws.close(),this._oauthCallbackResponse=null,this.notifyAuthSubs(n)}sendMagicCode({email:e}){return _s({apiURI:this.config.apiURI,appId:this.config.appId,email:e})}async signInWithMagicCode({email:e,code:n}){const r=await ws({apiURI:this.config.apiURI,appId:this.config.appId,email:e,code:n});return await this.changeCurrentUser(r.user),r}async signInWithCustomToken(e){const n=await gs({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:e});return await this.changeCurrentUser(n.user),n}potentiallyInvalidateToken(e,n){var i;const r=(i=e==null?void 0:e.user)==null?void 0:i.refresh_token;if(!r)return;if(n.invalidateToken===!1){A.info("[auth-invalidate] skipped invalidateToken");return}Ss({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:r}).then(()=>{A.info("[auth-invalidate] completed invalidateToken")}).catch(o=>{})}async signOut(e){const n=await this.getCurrentUser();this.potentiallyInvalidateToken(n,e),await this.changeCurrentUser(null)}createAuthorizationURL({clientName:e,redirectURL:n}){const{apiURI:r,appId:s}=this.config;return`${r}/runtime/oauth/start?app_id=${s}&client_name=${e}&redirect_uri=${n}`}async exchangeCodeForToken({code:e,codeVerifier:n}){const r=await rn({apiURI:this.config.apiURI,appId:this.config.appId,code:e,codeVerifier:n});return await this.changeCurrentUser(r.user),r}issuerURI(){const{apiURI:e,appId:n}=this.config;return`${e}/runtime/${n}`}async signInWithIdToken({idToken:e,clientName:n,nonce:r}){var a;const s=await this.getCurrentUser(),i=(a=s==null?void 0:s.user)==null?void 0:a.refresh_token,o=await ms({apiURI:this.config.apiURI,appId:this.config.appId,idToken:e,clientName:n,nonce:r,refreshToken:i});return await this.changeCurrentUser(o.user),o}joinRoom(e){return this._rooms[e]||(this._rooms[e]={isConnected:!1,error:void 0}),this._presence[e]=this._presence[e]||{},this._tryJoinRoom(e),()=>{this._cleanupRoom(e)}}_cleanupRoom(e){var n,r,s;if(!((r=(n=this._presence[e])==null?void 0:n.handlers)!=null&&r.length)&&!Object.keys(this._broadcastSubs[e]??{}).length){const i=(s=this._rooms[e])==null?void 0:s.isConnected;delete this._rooms[e],delete this._presence[e],delete this._broadcastSubs[e],i?this._tryLeaveRoom(e):this._roomsPendingLeave[e]=!0}}getPresence(e,n,r={}){const s=this._rooms[n],i=this._presence[n];return!s||!i||!i.result?null:{...Cs(i.result,r,this._sessionId),isLoading:!s.isConnected,error:s.error}}publishPresence(e,n,r){const s=this._rooms[n],i=this._presence[n];if(!s||!i)return;i.result=i.result||{};const o={...i.result.user,...r};i.result.user=o,s.isConnected&&(this._trySetPresence(n,o),this._notifyPresenceSubs(n))}_trySetPresence(e,n){this._trySendAuthed(k(),{op:"set-presence","room-id":e,data:n})}_tryJoinRoom(e){this._trySendAuthed(k(),{op:"join-room","room-id":e}),delete this._roomsPendingLeave[e]}_tryLeaveRoom(e){this._trySendAuthed(k(),{op:"leave-room","room-id":e})}subscribePresence(e,n,r,s){const i=this.joinRoom(n),o={...r,roomId:n,cb:s,prev:null};return this._presence[n]=this._presence[n]||{},this._presence[n].handlers=this._presence[n].handlers||[],this._presence[n].handlers.push(o),this._notifyPresenceSub(n,o),()=>{var a,c;this._presence[n].handlers=((c=(a=this._presence[n])==null?void 0:a.handlers)==null?void 0:c.filter(u=>u!==o))??[],i()}}_notifyPresenceSubs(e){var n,r;(r=(n=this._presence[e])==null?void 0:n.handlers)==null||r.forEach(s=>{this._notifyPresenceSub(e,s)})}_notifyPresenceSub(e,n){const r=this.getPresence("",e,n);r&&(n.prev&&!ks(r,n.prev)||(n.prev=r,n.cb(r)))}_patchPresencePeers(e,n){var o,a,c;const r=((a=(o=this._presence[e])==null?void 0:o.result)==null?void 0:a.peers)||{};let s=Object.fromEntries(Object.entries(r).map(([u,f])=>[u,{data:f}]));(c=this._presence[e])==null||c.result;const i=Ve(s,u=>{for(let[f,l,d]of n)switch(l){case"+":$n(u,f,d);break;case"r":jt(u,f,d);break;case"-":xt(u,f);break}delete u[this._sessionId]});this._setPresencePeers(e,i)}_setPresencePeers(e,n){const r={...n};delete r[this._sessionId];const s=Object.fromEntries(Object.entries(r).map(([i,o])=>[i,o.data]));this._presence=Ve(this._presence,i=>{jt(i,[e,"result","peers"],s)})}publishTopic({roomType:e,roomId:n,topic:r,data:s}){const i=this._rooms[n];if(i){if(!i.isConnected){this._broadcastQueue[n]=this._broadcastQueue[n]??[],this._broadcastQueue[n].push({topic:r,roomType:e,data:s});return}this._tryBroadcast(n,e,r,s)}}_tryBroadcast(e,n,r,s){this._trySendAuthed(k(),{op:"client-broadcast","room-id":e,roomType:n,topic:r,data:s})}subscribeTopic(e,n,r){const s=this.joinRoom(e);return this._broadcastSubs[e]=this._broadcastSubs[e]||{},this._broadcastSubs[e][n]=this._broadcastSubs[e][n]||[],this._broadcastSubs[e][n].push(r),this._presence[e]=this._presence[e]||{},()=>{this._broadcastSubs[e][n]=this._broadcastSubs[e][n].filter(i=>i!==r),this._broadcastSubs[e][n].length||delete this._broadcastSubs[e][n],s()}}_notifyBroadcastSubs(e,n,r){var s,i,o;(o=(i=(s=this._broadcastSubs)==null?void 0:s[e])==null?void 0:i[n])==null||o.forEach(a=>{var f,l,d,h,p,b;const c=(f=r.data)==null?void 0:f.data,u=r.data["peer-id"]===this._sessionId?(d=(l=this._presence[e])==null?void 0:l.result)==null?void 0:d.user:(b=(p=(h=this._presence[e])==null?void 0:h.result)==null?void 0:p.peers)==null?void 0:b[r.data["peer-id"]];return a(c,u)})}async uploadFile(e,n,r){var o;const s=await this.getCurrentUser(),i=(o=s==null?void 0:s.user)==null?void 0:o.refresh_token;return Os({...r,apiURI:this.config.apiURI,appId:this.config.appId,path:e,file:n,refreshToken:i})}async deleteFile(e){var i;const n=await this.getCurrentUser(),r=(i=n==null?void 0:n.user)==null?void 0:i.refresh_token;return await vs({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:r})}async upload(e,n){var c;const r=await this.getCurrentUser(),s=(c=r==null?void 0:r.user)==null?void 0:c.refresh_token,i=e||n.name,o=await Ms({apiURI:this.config.apiURI,appId:this.config.appId,fileName:i,refreshToken:s});return await Ps(o,n)}async getDownloadUrl(e){var i;const n=await this.getCurrentUser(),r=(i=n==null?void 0:n.user)==null?void 0:i.refresh_token;return await As({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:r})}}class B{constructor(e,n,r={indexed:!1,unique:!1}){this.valueType=e,this.required=n,this.config=r}optional(){return new B(this.valueType,!1)}unique(){return new B(this.valueType,this.required,{...this.config,unique:!0})}indexed(){return new B(this.valueType,this.required,{...this.config,indexed:!0})}}class Ae{constructor(e,n){this.attrs=e,this.links=n}asType(){return new Ae(this.attrs,this.links)}}class Ce{constructor(e,n,r){this.entities=e,this.links=n,this.rooms=r}withRoomSchema(){return new Ce(this.entities,this.links,{})}}function Ls(t,e){return new Ce(dn(t,e),e,void 0)}function qs(t){return new Ae(t,{})}function Fs(){return new B("string",!0)}function zs(){return new B("number",!0)}function Vs(){return new B("boolean",!0)}function Ws(){return new B("date",!0)}function Qs(){return new B("json",!0)}function Bs(){return new B("json",!0)}function dn(t,e){var s,i,o,a;const n={fwd:{},rev:{}};for(const c of Object.values(e))(s=n.fwd)[i=c.forward.on]||(s[i]={}),(o=n.rev)[a=c.reverse.on]||(o[a]={}),n.fwd[c.forward.on][c.forward.label]={entityName:c.reverse.on,cardinality:c.forward.has},n.rev[c.reverse.on][c.reverse.label]={entityName:c.forward.on,cardinality:c.reverse.has};return Object.fromEntries(Object.entries(t).map(([c,u])=>[c,new Ae(u.attrs,{...n.fwd[c],...n.rev[c]})]))}function Js({entities:t,links:e,rooms:n}){const r=e??{},s=n??{};return new Ce(dn(t,r),r,s)}const Ks={graph:Ls,schema:Js,entity:qs,string:Fs,number:zs,boolean:Vs,date:Ws,json:Qs,any:Bs};let ke;function Hs(t,e){ke==null||ke.dispose();const n=ti(e),r=Xs(e,a),s=Ys(Gs(t));function i(f){var l;f.source===s.element.contentWindow&&((l=f.data)==null?void 0:l.type)==="close"&&n.isVisible()&&a()}function o(f){const l=f.shiftKey&&f.ctrlKey&&f.key==="0",d=f.key==="Escape"||f.key==="Esc";(l||d&&n.isVisible())&&a()}function a(){n.isVisible()?n.element.style.display="none":(n.element.style.display="block",n.element.contains(s.element)||n.element.appendChild(s.element))}function c(){n.element.remove(),r.element.remove(),removeEventListener("keydown",o),removeEventListener("message",i)}function u(){document.body.appendChild(n.element),document.body.appendChild(r.element),addEventListener("keydown",o),addEventListener("message",i),ke={dispose:c}}return u()}function Gs(t){return`${E||_t?"http://localhost:3000":"https://instantdb.com"}/_devtool?appId=${t}`}function Ys(t){const e=document.createElement("iframe");return e.src=t,e.className="instant-devtool-iframe",Object.assign(e.style,{width:"100%",height:"100%",backgroundColor:"white",border:"none"}),{element:e}}function Xs(t,e){const n=`
    <svg width="32" height="32" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="512" height="512" fill="black"/>
      <rect x="97.0973" y="91.3297" width="140" height="330" fill="white"/>
    </svg>
  `,r=document.createElement("button");return r.innerHTML=n,r.className="instant-devtool-toggler",Object.assign(r.style,{position:"fixed",...Zs(t.position),height:"32px",width:"32px",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"9010",padding:"0",margin:"0",border:"none",cursor:"pointer"}),r.addEventListener("click",e),{element:r}}function Zs(t){switch(t){case"bottom-left":return{bottom:"24px",left:"24px"};case"bottom-right":return{bottom:"24px",right:"24px"};case"top-right":return{top:"24px",right:"24px"};case"top-left":return{top:"24px",left:"24px"}}}function ei(t){switch(t){case"bottom-left":return{bottom:"24px",right:"24px",left:"60px",top:"72px"};case"bottom-right":return{bottom:"24px",left:"24px",right:"60px",top:"72px"};case"top-right":return{top:"24px",left:"24px",right:"60px",bottom:"72px"};case"top-left":return{top:"24px",right:"24px",left:"60px",bottom:"72px"}}}function ti(t){const e=document.createElement("div");Object.assign(e.style,{position:"fixed",...ei(t.position),display:"block",borderRadius:"4px",border:"1px #ccc solid",boxShadow:"0px 0px 8px #00000044",backgroundColor:"#eee",zIndex:"999990"}),e.style.display="none",e.className="instant-devtool-container";function n(){return e.style.display!=="none"}return{element:e,isVisible:n}}const ni={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"};function ri(){return globalThis.__instantDbStore=globalThis.__instantDbStore??{},globalThis.__instantDbStore}function ht(t){const e=t.__adminToken;return t.appId+"_"+(t.websocketURI||"default_ws_uri")+"_"+(t.apiURI||"default_api_uri")+"_"+(e||"client_only")}const pt=ri();class hn{constructor(e){this.db=e,this.sendMagicCode=n=>this.db.sendMagicCode(n),this.signInWithMagicCode=n=>this.db.signInWithMagicCode(n),this.signInWithToken=n=>this.db.signInWithCustomToken(n),this.createAuthorizationURL=n=>this.db.createAuthorizationURL(n),this.signInWithIdToken=n=>this.db.signInWithIdToken(n),this.exchangeOAuthCode=n=>this.db.exchangeCodeForToken(n),this.issuerURI=()=>this.db.issuerURI(),this.signOut=(n={invalidateToken:!0})=>this.db.signOut(n)}}class pn{constructor(e){this.db=e,this.uploadFile=(n,r,s={})=>this.db.uploadFile(n,r,s),this.delete=n=>this.db.deleteFile(n),this.upload=(n,r)=>this.db.upload(n,r),this.put=this.upload,this.getDownloadUrl=n=>this.db.getDownloadUrl(n)}}function si(t){return JSON.parse(JSON.stringify(t))}class yn{constructor(e){this.tx=nt(),this._reactor=e,this.auth=new hn(this._reactor),this.storage=new pn(this._reactor)}transact(e){return this._reactor.pushTx(e)}getLocalId(e){return this._reactor.getLocalId(e)}subscribeQuery(e,n,r){return this._reactor.subscribeQuery(e,n,r)}subscribeAuth(e){return this._reactor.subscribeAuth(e)}getAuth(){return this._reactor.getAuth()}subscribeConnectionStatus(e){return this._reactor.subscribeConnectionStatus(e)}joinRoom(e="_defaultRoomType",n="_defaultRoomId"){return{leaveRoom:this._reactor.joinRoom(n),subscribeTopic:(s,i)=>this._reactor.subscribeTopic(n,s,i),subscribePresence:(s,i)=>this._reactor.subscribePresence(e,n,s,i),publishTopic:(s,i)=>this._reactor.publishTopic({roomType:e,roomId:n,topic:s,data:i}),publishPresence:s=>this._reactor.publishPresence(e,n,s),getPresence:s=>this._reactor.getPresence(e,n,s)}}shutdown(){delete pt[ht(this._reactor.config)],this._reactor.shutdown()}queryOnce(e,n){return this._reactor.queryOnce(e,n)}}function bn(t,e,n,r){const s=pt[ht(t)];if(s)return s;const i=new Ns({...ni,...t,cardinalityInference:!!t.schema},e||ct,n||ut,{...r||{},"@instantdb/core":ft}),o=new yn(i);return pt[ht(t)]=o,ii(t.appId,t.devtool),o}function ii(t,e){if(typeof window>"u"||typeof window.location>"u"||typeof document>"u"||typeof e=="boolean"&&!e)return;const n={position:"bottom-right",allowedHosts:["localhost"],...typeof e=="object"?e:{}};n.allowedHosts.includes(window.location.hostname)&&Hs(t,n)}const oi=bn;O.Auth=hn,O.IndexedDBStorage=ct,O.InstantCoreDatabase=yn,O.Storage=pn,O.WindowNetworkListener=ut,O.coerceQuery=si,O.getOps=en,O.i=Ks,O.id=k,O.init=bn,O.init_experimental=oi,O.lookup=Qr,O.tx=Jr,O.txInit=nt,O.version=ft,O.weakHash=x,Object.defineProperty(O,Symbol.toStringTag,{value:"Module"})});
